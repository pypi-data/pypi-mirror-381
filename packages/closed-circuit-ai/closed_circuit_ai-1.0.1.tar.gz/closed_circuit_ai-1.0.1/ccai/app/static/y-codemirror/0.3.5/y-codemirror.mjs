import*as ot from"yjs";import*as nt from"@codemirror/view";import"@codemirror/state";import*as g from"yjs";var E=class o{constructor(t,e){this.yanchor=t,this.yhead=e}toJSON(){return{yanchor:g.relativePositionToJSON(this.yanchor),yhead:g.relativePositionToJSON(this.yhead)}}static fromJSON(t){return new o(g.createRelativePositionFromJSON(t.yanchor),g.createRelativePositionFromJSON(t.yhead))}};import*as u from"yjs";import*as x from"@codemirror/state";import*as B from"@codemirror/view";var N=class{constructor(t,e){this.ytext=t,this.awareness=e,this.undoManager=new u.UndoManager(t)}toYPos(t,e=0){return u.createRelativePositionFromTypeIndex(this.ytext,t,e)}fromYPos(t){let e=u.createAbsolutePositionFromRelativePosition(u.createRelativePositionFromJSON(t),this.ytext.doc);if(e==null||e.type!==this.ytext)throw new Error("[y-codemirror] The position you want to retrieve was created by a different document");return{pos:e.index,assoc:e.assoc}}toYRange(t){let e=t.assoc,n=this.toYPos(t.anchor,e),r=this.toYPos(t.head,e);return new E(n,r)}fromYRange(t){let e=this.fromYPos(t.yanchor),n=this.fromYPos(t.yhead);return e.pos===n.pos?x.EditorSelection.cursor(n.pos,n.assoc):x.EditorSelection.range(e.pos,n.pos)}},y=x.Facet.define({combine(o){return o[o.length-1]}}),T=x.Annotation.define(),I=class{constructor(t){this.view=t,this.conf=t.state.facet(y),this._observer=(e,n)=>{if(n.origin!==this.conf){let r=e.delta,i=[],s=0;for(let a=0;a<r.length;a++){let c=r[a];c.insert!=null?i.push({from:s,to:s,insert:c.insert}):c.delete!=null?(i.push({from:s,to:s+c.delete,insert:""}),s+=c.delete):s+=c.retain}t.dispatch({changes:i,annotations:[T.of(this.conf)]})}},this._ytext=this.conf.ytext,this._ytext.observe(this._observer)}update(t){if(!t.docChanged||t.transactions.length>0&&t.transactions[0].annotation(T)===this.conf)return;let e=this.conf.ytext;e.doc.transact(()=>{let n=0;t.changes.iterChanges((r,i,s,a,c)=>{let d=c.sliceString(0,c.length,`
`);r!==i&&e.delete(r+n,i-r),d.length>0&&e.insert(r+n,d),n+=d.length-(i-r)})},this.conf)}destroy(){this._ytext.unobserve(this._observer)}},H=B.ViewPlugin.fromClass(I);import*as l from"@codemirror/view";import*as O from"@codemirror/state";var L=class{constructor(t,e){this.left=t,this.right=e}},b=(o,t)=>new L(o,t);var W=(o,t)=>o.forEach(e=>t(e.left,e.right));var p=typeof document<"u"?document:{},st=o=>p.createElement(o),it=()=>p.createDocumentFragment(),ct=o=>p.createTextNode(o),gt=typeof DOMParser<"u"?new DOMParser:null;var at=(o,t)=>(W(t,(e,n)=>{n===!1?o.removeAttribute(e):n===!0?o.setAttribute(e,""):o.setAttribute(e,n)}),o);var lt=o=>{let t=it();for(let e=0;e<o.length;e++)G(t,o[e]);return t},mt=(o,t)=>(G(o,lt(t)),o);var D=(o,t=[],e=[])=>mt(at(st(o),t),e);var w=ct;var G=(o,t)=>o.appendChild(t),St=p.ELEMENT_NODE,Et=p.TEXT_NODE,bt=p.CDATA_SECTION_NODE,wt=p.COMMENT_NODE,Mt=p.DOCUMENT_NODE,vt=p.DOCUMENT_TYPE_NODE,_t=p.DOCUMENT_FRAGMENT_NODE;var K=(o,t)=>o<t?o:t,X=(o,t)=>o>t?o:t,Nt=Number.isNaN;import*as m from"yjs";var Z=l.EditorView.baseTheme({".cm-ySelection":{},".cm-yLineSelection":{padding:0,margin:"0px 2px 0px 4px"},".cm-ySelectionCaret":{position:"relative",borderLeft:"1px solid black",borderRight:"1px solid black",marginLeft:"-1px",marginRight:"-1px",boxSizing:"border-box",display:"inline"},".cm-ySelectionCaretDot":{borderRadius:"50%",position:"absolute",width:".4em",height:".4em",top:"-.2em",left:"-.2em",backgroundColor:"inherit",transition:"transform .3s ease-in-out",boxSizing:"border-box"},".cm-ySelectionCaret:hover > .cm-ySelectionCaretDot":{transformOrigin:"bottom center",transform:"scale(0)"},".cm-ySelectionInfo":{position:"absolute",top:"-1.05em",left:"-1px",fontSize:".75em",fontFamily:"serif",fontStyle:"normal",fontWeight:"normal",lineHeight:"normal",userSelect:"none",color:"white",paddingLeft:"2px",paddingRight:"2px",zIndex:101,transition:"opacity .3s ease-in-out",backgroundColor:"inherit",opacity:0,transitionDelay:"0s",whiteSpace:"nowrap"},".cm-ySelectionCaret:hover > .cm-ySelectionInfo":{opacity:1,transitionDelay:"0s"}}),pt=O.Annotation.define(),U=class extends l.WidgetType{constructor(t,e){super(),this.color=t,this.name=e}toDOM(){return D("span",[b("class","cm-ySelectionCaret"),b("style",`background-color: ${this.color}; border-color: ${this.color}`)],[w("\u2060"),D("div",[b("class","cm-ySelectionCaretDot")]),w("\u2060"),D("div",[b("class","cm-ySelectionInfo")],[w(this.name)]),w("\u2060")])}eq(t){return t.color===this.color}compare(t){return t.color===this.color}updateDOM(){return!1}get estimatedHeight(){return-1}ignoreEvent(){return!0}},$=class{constructor(t){this.conf=t.state.facet(y),this._listener=({added:e,updated:n,removed:r},i,s)=>{e.concat(n).concat(r).findIndex(c=>c!==this.conf.awareness.doc.clientID)>=0&&t.dispatch({annotations:[pt.of([])]})},this._awareness=this.conf.awareness,this._awareness.on("change",this._listener),this.decorations=O.RangeSet.of([])}destroy(){this._awareness.off("change",this._listener)}update(t){let e=this.conf.ytext,n=e.doc,r=this.conf.awareness,i=[],s=this.conf.awareness.getLocalState();if(s!=null){let a=t.view.hasFocus&&t.view.dom.ownerDocument.hasFocus(),c=a?t.state.selection.main:null,d=s.cursor==null?null:m.createRelativePositionFromJSON(s.cursor.anchor),f=s.cursor==null?null:m.createRelativePositionFromJSON(s.cursor.head);if(c!=null){let h=m.createRelativePositionFromTypeIndex(e,c.anchor),S=m.createRelativePositionFromTypeIndex(e,c.head);(s.cursor==null||!m.compareRelativePositions(d,h)||!m.compareRelativePositions(f,S))&&r.setLocalStateField("cursor",{anchor:h,head:S})}else s.cursor!=null&&a&&r.setLocalStateField("cursor",null)}r.getStates().forEach((a,c)=>{if(c===r.doc.clientID)return;let d=a.cursor;if(d==null||d.anchor==null||d.head==null)return;let f=m.createAbsolutePositionFromRelativePosition(d.anchor,n),h=m.createAbsolutePositionFromRelativePosition(d.head,n);if(f==null||h==null||f.type!==e||h.type!==e)return;let{color:S="#30bced",name:rt="Anonymous"}=a.user||{},v=a.user&&a.user.colorLight||S+"33",F=K(f.index,h.index),R=X(f.index,h.index),_=t.view.state.doc.lineAt(F),A=t.view.state.doc.lineAt(R);if(_.number===A.number)i.push({from:F,to:R,value:l.Decoration.mark({attributes:{style:`background-color: ${v}`},class:"cm-ySelection"})});else{i.push({from:F,to:_.from+_.length,value:l.Decoration.mark({attributes:{style:`background-color: ${v}`},class:"cm-ySelection"})}),i.push({from:A.from,to:R,value:l.Decoration.mark({attributes:{style:`background-color: ${v}`},class:"cm-ySelection"})});for(let V=_.number+1;V<A.number;V++){let z=t.view.state.doc.line(V).from;i.push({from:z,to:z,value:l.Decoration.line({attributes:{style:`background-color: ${v}`,class:"cm-yLineSelection"}})})}}i.push({from:h.index,to:h.index,value:l.Decoration.widget({side:h.index-f.index>0?-1:1,block:!1,widget:new U(S,rt)})})}),this.decorations=l.Decoration.set(i,!0)}},Q=l.ViewPlugin.fromClass($,{decorations:o=>o.decorations});import"yjs";import*as P from"@codemirror/state";import*as Y from"@codemirror/view";var tt=()=>{let o=!0;return(t,e)=>{if(o){o=!1;try{t()}finally{o=!0}}else e!==void 0&&e()}};var C=class{constructor(t){this.undoManager=t}addTrackedOrigin(t){this.undoManager.addTrackedOrigin(t)}removeTrackedOrigin(t){this.undoManager.removeTrackedOrigin(t)}undo(){return this.undoManager.undo()!=null}redo(){return this.undoManager.redo()!=null}},M=P.Facet.define({combine(o){return o[o.length-1]}}),Yt=P.Annotation.define(),J=class{constructor(t){this.view=t,this.conf=t.state.facet(M),this._undoManager=this.conf.undoManager,this.syncConf=t.state.facet(y),this._beforeChangeSelection=null,this._mux=tt(),this._onStackItemAdded=({stackItem:e,changedParentTypes:n})=>{n.has(this.syncConf.ytext)&&this._beforeChangeSelection&&!e.meta.has(this)&&e.meta.set(this,this._beforeChangeSelection)},this._onStackItemPopped=({stackItem:e})=>{let n=e.meta.get(this);if(n){let r=this.syncConf.fromYRange(n);t.dispatch(t.state.update({selection:r,effects:[Y.EditorView.scrollIntoView(r)]})),this._storeSelection()}},this._storeSelection=()=>{this._beforeChangeSelection=this.syncConf.toYRange(this.view.state.selection.main)},this._undoManager.on("stack-item-added",this._onStackItemAdded),this._undoManager.on("stack-item-popped",this._onStackItemPopped),this._undoManager.addTrackedOrigin(this.syncConf)}update(t){t.selectionSet&&(t.transactions.length===0||t.transactions[0].annotation(T)!==this.syncConf)&&this._storeSelection()}destroy(){this._undoManager.off("stack-item-added",this._onStackItemAdded),this._undoManager.off("stack-item-popped",this._onStackItemPopped),this._undoManager.removeTrackedOrigin(this.syncConf)}},et=Y.ViewPlugin.fromClass(J),q=({state:o,dispatch:t})=>o.facet(M).undo()||!0,k=({state:o,dispatch:t})=>o.facet(M).redo()||!0;var ut=[{key:"Mod-z",run:q,preventDefault:!0},{key:"Mod-y",mac:"Mod-Shift-z",run:k,preventDefault:!0},{key:"Mod-Shift-z",run:k,preventDefault:!0}];var Ut=(o,t,{undoManager:e=new ot.UndoManager(o)}={})=>{let n=new N(o,t),r=[y.of(n),H];return t&&r.push(Z,Q),e!==!1&&r.push(M.of(new C(e)),et,nt.EditorView.domEventHandlers({beforeinput(i,s){return i.inputType==="historyUndo"?q(s):i.inputType==="historyRedo"?k(s):!1}})),r};export{E as YRange,N as YSyncConfig,Ut as yCollab,Q as yRemoteSelections,Z as yRemoteSelectionsTheme,H as ySync,y as ySyncFacet,ut as yUndoManagerKeymap};
