var Fe=1024,ze=0,z=class{constructor(e,t){this.from=e,this.to=t}},b=class{constructor(e={}){this.id=ze++,this.perNode=!!e.perNode,this.deserialize=e.deserialize||(()=>{throw new Error("This node type doesn't define a deserialize function")})}add(e){if(this.perNode)throw new RangeError("Can't add per-node props to node types");return typeof e!="function"&&(e=F.match(e)),t=>{let r=e(t);return r===void 0?null:[this,r]}}};b.closedBy=new b({deserialize:s=>s.split(" ")});b.openedBy=new b({deserialize:s=>s.split(" ")});b.group=new b({deserialize:s=>s.split(" ")});b.isolate=new b({deserialize:s=>{if(s&&s!="rtl"&&s!="ltr"&&s!="auto")throw new RangeError("Invalid value for isolate: "+s);return s||"auto"}});b.contextHash=new b({perNode:!0});b.lookAhead=new b({perNode:!0});b.mounted=new b({perNode:!0});var V=class{constructor(e,t,r){this.tree=e,this.overlay=t,this.parser=r}static get(e){return e&&e.props&&e.props[b.mounted.id]}},Pe=Object.create(null),F=class s{constructor(e,t,r,n=0){this.name=e,this.props=t,this.id=r,this.flags=n}static define(e){let t=e.props&&e.props.length?Object.create(null):Pe,r=(e.top?1:0)|(e.skipped?2:0)|(e.error?4:0)|(e.name==null?8:0),n=new s(e.name||"",t,e.id,r);if(e.props){for(let i of e.props)if(Array.isArray(i)||(i=i(n)),i){if(i[0].perNode)throw new RangeError("Can't store a per-node prop on a node type");t[i[0].id]=i[1]}}return n}prop(e){return this.props[e.id]}get isTop(){return(this.flags&1)>0}get isSkipped(){return(this.flags&2)>0}get isError(){return(this.flags&4)>0}get isAnonymous(){return(this.flags&8)>0}is(e){if(typeof e=="string"){if(this.name==e)return!0;let t=this.prop(b.group);return t?t.indexOf(e)>-1:!1}return this.id==e}static match(e){let t=Object.create(null);for(let r in e)for(let n of r.split(" "))t[n]=e[r];return r=>{for(let n=r.prop(b.group),i=-1;i<(n?n.length:0);i++){let l=t[i<0?r.name:n[i]];if(l)return l}}}};F.none=new F("",Object.create(null),0,8);var xe=class s{constructor(e){this.types=e;for(let t=0;t<e.length;t++)if(e[t].id!=t)throw new RangeError("Node type ids should correspond to array positions when creating a node set")}extend(...e){let t=[];for(let r of this.types){let n=null;for(let i of e){let l=i(r);l&&(n||(n=Object.assign({},r.props)),n[l[0].id]=l[1])}t.push(n?new F(r.name,n,r.id,r.flags):r)}return new s(t)}},Z=new WeakMap,be=new WeakMap,S;(function(s){s[s.ExcludeBuffers=1]="ExcludeBuffers",s[s.IncludeAnonymous=2]="IncludeAnonymous",s[s.IgnoreMounts=4]="IgnoreMounts",s[s.IgnoreOverlays=8]="IgnoreOverlays"})(S||(S={}));var O=class s{constructor(e,t,r,n,i){if(this.type=e,this.children=t,this.positions=r,this.length=n,this.props=null,i&&i.length){this.props=Object.create(null);for(let[l,f]of i)this.props[typeof l=="number"?l:l.id]=f}}toString(){let e=V.get(this);if(e&&!e.overlay)return e.tree.toString();let t="";for(let r of this.children){let n=r.toString();n&&(t&&(t+=","),t+=n)}return this.type.name?(/\W/.test(this.type.name)&&!this.type.isError?JSON.stringify(this.type.name):this.type.name)+(t.length?"("+t+")":""):t}cursor(e=0){return new q(this.topNode,e)}cursorAt(e,t=0,r=0){let n=Z.get(this)||this.topNode,i=new q(n);return i.moveTo(e,t),Z.set(this,i._tree),i}get topNode(){return new P(this,0,0,null)}resolve(e,t=0){let r=Q(Z.get(this)||this.topNode,e,t,!1);return Z.set(this,r),r}resolveInner(e,t=0){let r=Q(be.get(this)||this.topNode,e,t,!0);return be.set(this,r),r}resolveStack(e,t=0){return Ee(this,e,t)}iterate(e){let{enter:t,leave:r,from:n=0,to:i=this.length}=e,l=e.mode||0,f=(l&S.IncludeAnonymous)>0;for(let h=this.cursor(l|S.IncludeAnonymous);;){let u=!1;if(h.from<=i&&h.to>=n&&(!f&&h.type.isAnonymous||t(h)!==!1)){if(h.firstChild())continue;u=!0}for(;u&&r&&(f||!h.type.isAnonymous)&&r(h),!h.nextSibling();){if(!h.parent())return;u=!0}}}prop(e){return e.perNode?this.props?this.props[e.id]:void 0:this.type.prop(e)}get propValues(){let e=[];if(this.props)for(let t in this.props)e.push([+t,this.props[t]]);return e}balance(e={}){return this.children.length<=8?this:ge(F.none,this.children,this.positions,0,this.children.length,0,this.length,(t,r,n)=>new s(this.type,t,r,n,this.propValues),e.makeTree||((t,r,n)=>new s(F.none,t,r,n)))}static build(e){return Me(e)}};O.empty=new O(F.none,[],[],0);var se=class s{constructor(e,t){this.buffer=e,this.index=t}get id(){return this.buffer[this.index-4]}get start(){return this.buffer[this.index-3]}get end(){return this.buffer[this.index-2]}get size(){return this.buffer[this.index-1]}get pos(){return this.index}next(){this.index-=4}fork(){return new s(this.buffer,this.index)}},W=class s{constructor(e,t,r){this.buffer=e,this.length=t,this.set=r}get type(){return F.none}toString(){let e=[];for(let t=0;t<this.buffer.length;)e.push(this.childString(t)),t=this.buffer[t+3];return e.join(",")}childString(e){let t=this.buffer[e],r=this.buffer[e+3],n=this.set.types[t],i=n.name;if(/\W/.test(i)&&!n.isError&&(i=JSON.stringify(i)),e+=4,r==e)return i;let l=[];for(;e<r;)l.push(this.childString(e)),e=this.buffer[e+3];return i+"("+l.join(",")+")"}findChild(e,t,r,n,i){let{buffer:l}=this,f=-1;for(let h=e;h!=t&&!(Ne(i,n,l[h+1],l[h+2])&&(f=h,r>0));h=l[h+3]);return f}slice(e,t,r){let n=this.buffer,i=new Uint16Array(t-e),l=0;for(let f=e,h=0;f<t;){i[h++]=n[f++],i[h++]=n[f++]-r;let u=i[h++]=n[f++]-r;i[h++]=n[f++]-e,l=Math.max(l,u)}return new s(i,l,this.set)}};function Ne(s,e,t,r){switch(s){case-2:return t<e;case-1:return r>=e&&t<e;case 0:return t<e&&r>e;case 1:return t<=e&&r>e;case 2:return r>e;case 4:return!0}}function Q(s,e,t,r){for(var n;s.from==s.to||(t<1?s.from>=e:s.from>e)||(t>-1?s.to<=e:s.to<e);){let l=!r&&s instanceof P&&s.index<0?null:s.parent;if(!l)return s;s=l}let i=r?0:S.IgnoreOverlays;if(r)for(let l=s,f=l.parent;f;l=f,f=l.parent)l instanceof P&&l.index<0&&((n=f.enter(e,t,i))===null||n===void 0?void 0:n.from)!=l.from&&(s=f);for(;;){let l=s.enter(e,t,i);if(!l)return s;s=l}}var te=class{cursor(e=0){return new q(this,e)}getChild(e,t=null,r=null){let n=we(this,e,t,r);return n.length?n[0]:null}getChildren(e,t=null,r=null){return we(this,e,t,r)}resolve(e,t=0){return Q(this,e,t,!1)}resolveInner(e,t=0){return Q(this,e,t,!0)}matchContext(e){return le(this.parent,e)}enterUnfinishedNodesBefore(e){let t=this.childBefore(e),r=this;for(;t;){let n=t.lastChild;if(!n||n.to!=t.to)break;n.type.isError&&n.from==n.to?(r=t,t=n.prevSibling):t=n}return r}get node(){return this}get next(){return this.parent}},P=class s extends te{constructor(e,t,r,n){super(),this._tree=e,this.from=t,this.index=r,this._parent=n}get type(){return this._tree.type}get name(){return this._tree.type.name}get to(){return this.from+this._tree.length}nextChild(e,t,r,n,i=0){for(let l=this;;){for(let{children:f,positions:h}=l._tree,u=t>0?f.length:-1;e!=u;e+=t){let o=f[e],c=h[e]+l.from;if(Ne(n,r,c,c+o.length)){if(o instanceof W){if(i&S.ExcludeBuffers)continue;let d=o.findChild(0,o.buffer.length,t,r-c,n);if(d>-1)return new G(new fe(l,o,e,c),null,d)}else if(i&S.IncludeAnonymous||!o.type.isAnonymous||ce(o)){let d;if(!(i&S.IgnoreMounts)&&(d=V.get(o))&&!d.overlay)return new s(d.tree,c,e,l);let y=new s(o,c,e,l);return i&S.IncludeAnonymous||!y.type.isAnonymous?y:y.nextChild(t<0?o.children.length-1:0,t,r,n)}}}if(i&S.IncludeAnonymous||!l.type.isAnonymous||(l.index>=0?e=l.index+t:e=t<0?-1:l._parent._tree.children.length,l=l._parent,!l))return null}}get firstChild(){return this.nextChild(0,1,0,4)}get lastChild(){return this.nextChild(this._tree.children.length-1,-1,0,4)}childAfter(e){return this.nextChild(0,1,e,2)}childBefore(e){return this.nextChild(this._tree.children.length-1,-1,e,-2)}enter(e,t,r=0){let n;if(!(r&S.IgnoreOverlays)&&(n=V.get(this._tree))&&n.overlay){let i=e-this.from;for(let{from:l,to:f}of n.overlay)if((t>0?l<=i:l<i)&&(t<0?f>=i:f>i))return new s(n.tree,n.overlay[0].from+this.from,-1,this)}return this.nextChild(0,1,e,t,r)}nextSignificantParent(){let e=this;for(;e.type.isAnonymous&&e._parent;)e=e._parent;return e}get parent(){return this._parent?this._parent.nextSignificantParent():null}get nextSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index+1,1,0,4):null}get prevSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index-1,-1,0,4):null}get tree(){return this._tree}toTree(){return this._tree}toString(){return this._tree.toString()}};function we(s,e,t,r){let n=s.cursor(),i=[];if(!n.firstChild())return i;if(t!=null){for(let l=!1;!l;)if(l=n.type.is(t),!n.nextSibling())return i}for(;;){if(r!=null&&n.type.is(r))return i;if(n.type.is(e)&&i.push(n.node),!n.nextSibling())return r==null?i:[]}}function le(s,e,t=e.length-1){for(let r=s;t>=0;r=r.parent){if(!r)return!1;if(!r.type.isAnonymous){if(e[t]&&e[t]!=r.name)return!1;t--}}return!0}var fe=class{constructor(e,t,r,n){this.parent=e,this.buffer=t,this.index=r,this.start=n}},G=class s extends te{get name(){return this.type.name}get from(){return this.context.start+this.context.buffer.buffer[this.index+1]}get to(){return this.context.start+this.context.buffer.buffer[this.index+2]}constructor(e,t,r){super(),this.context=e,this._parent=t,this.index=r,this.type=e.buffer.set.types[e.buffer.buffer[r]]}child(e,t,r){let{buffer:n}=this.context,i=n.findChild(this.index+4,n.buffer[this.index+3],e,t-this.context.start,r);return i<0?null:new s(this.context,this,i)}get firstChild(){return this.child(1,0,4)}get lastChild(){return this.child(-1,0,4)}childAfter(e){return this.child(1,e,2)}childBefore(e){return this.child(-1,e,-2)}enter(e,t,r=0){if(r&S.ExcludeBuffers)return null;let{buffer:n}=this.context,i=n.findChild(this.index+4,n.buffer[this.index+3],t>0?1:-1,e-this.context.start,t);return i<0?null:new s(this.context,this,i)}get parent(){return this._parent||this.context.parent.nextSignificantParent()}externalSibling(e){return this._parent?null:this.context.parent.nextChild(this.context.index+e,e,0,4)}get nextSibling(){let{buffer:e}=this.context,t=e.buffer[this.index+3];return t<(this._parent?e.buffer[this._parent.index+3]:e.buffer.length)?new s(this.context,this._parent,t):this.externalSibling(1)}get prevSibling(){let{buffer:e}=this.context,t=this._parent?this._parent.index+4:0;return this.index==t?this.externalSibling(-1):new s(this.context,this._parent,e.findChild(t,this.index,-1,0,4))}get tree(){return null}toTree(){let e=[],t=[],{buffer:r}=this.context,n=this.index+4,i=r.buffer[this.index+3];if(i>n){let l=r.buffer[this.index+1];e.push(r.slice(n,i,l)),t.push(0)}return new O(this.type,e,t,this.to-this.from)}toString(){return this.context.buffer.childString(this.index)}};function Be(s){if(!s.length)return null;let e=0,t=s[0];for(let i=1;i<s.length;i++){let l=s[i];(l.from>t.from||l.to<t.to)&&(t=l,e=i)}let r=t instanceof P&&t.index<0?null:t.parent,n=s.slice();return r?n[e]=r:n.splice(e,1),new he(n,t)}var he=class{constructor(e,t){this.heads=e,this.node=t}get next(){return Be(this.heads)}};function Ee(s,e,t){let r=s.resolveInner(e,t),n=null;for(let i=r instanceof P?r:r.context.parent;i;i=i.parent)if(i.index<0){let l=i.parent;(n||(n=[r])).push(l.resolve(e,t)),i=l}else{let l=V.get(i.tree);if(l&&l.overlay&&l.overlay[0].from<=e&&l.overlay[l.overlay.length-1].to>=e){let f=new P(l.tree,l.overlay[0].from+i.from,-1,i);(n||(n=[r])).push(Q(f,e,t,!1))}}return n?Be(n):r}var q=class{get name(){return this.type.name}constructor(e,t=0){if(this.mode=t,this.buffer=null,this.stack=[],this.index=0,this.bufferNode=null,e instanceof P)this.yieldNode(e);else{this._tree=e.context.parent,this.buffer=e.context;for(let r=e._parent;r;r=r._parent)this.stack.unshift(r.index);this.bufferNode=e,this.yieldBuf(e.index)}}yieldNode(e){return e?(this._tree=e,this.type=e.type,this.from=e.from,this.to=e.to,!0):!1}yieldBuf(e,t){this.index=e;let{start:r,buffer:n}=this.buffer;return this.type=t||n.set.types[n.buffer[e]],this.from=r+n.buffer[e+1],this.to=r+n.buffer[e+2],!0}yield(e){return e?e instanceof P?(this.buffer=null,this.yieldNode(e)):(this.buffer=e.context,this.yieldBuf(e.index,e.type)):!1}toString(){return this.buffer?this.buffer.buffer.childString(this.index):this._tree.toString()}enterChild(e,t,r){if(!this.buffer)return this.yield(this._tree.nextChild(e<0?this._tree._tree.children.length-1:0,e,t,r,this.mode));let{buffer:n}=this.buffer,i=n.findChild(this.index+4,n.buffer[this.index+3],e,t-this.buffer.start,r);return i<0?!1:(this.stack.push(this.index),this.yieldBuf(i))}firstChild(){return this.enterChild(1,0,4)}lastChild(){return this.enterChild(-1,0,4)}childAfter(e){return this.enterChild(1,e,2)}childBefore(e){return this.enterChild(-1,e,-2)}enter(e,t,r=this.mode){return this.buffer?r&S.ExcludeBuffers?!1:this.enterChild(1,e,t):this.yield(this._tree.enter(e,t,r))}parent(){if(!this.buffer)return this.yieldNode(this.mode&S.IncludeAnonymous?this._tree._parent:this._tree.parent);if(this.stack.length)return this.yieldBuf(this.stack.pop());let e=this.mode&S.IncludeAnonymous?this.buffer.parent:this.buffer.parent.nextSignificantParent();return this.buffer=null,this.yieldNode(e)}sibling(e){if(!this.buffer)return this._tree._parent?this.yield(this._tree.index<0?null:this._tree._parent.nextChild(this._tree.index+e,e,0,4,this.mode)):!1;let{buffer:t}=this.buffer,r=this.stack.length-1;if(e<0){let n=r<0?0:this.stack[r]+4;if(this.index!=n)return this.yieldBuf(t.findChild(n,this.index,-1,0,4))}else{let n=t.buffer[this.index+3];if(n<(r<0?t.buffer.length:t.buffer[this.stack[r]+3]))return this.yieldBuf(n)}return r<0?this.yield(this.buffer.parent.nextChild(this.buffer.index+e,e,0,4,this.mode)):!1}nextSibling(){return this.sibling(1)}prevSibling(){return this.sibling(-1)}atLastNode(e){let t,r,{buffer:n}=this;if(n){if(e>0){if(this.index<n.buffer.buffer.length)return!1}else for(let i=0;i<this.index;i++)if(n.buffer.buffer[i+3]<this.index)return!1;({index:t,parent:r}=n)}else({index:t,_parent:r}=this._tree);for(;r;{index:t,_parent:r}=r)if(t>-1)for(let i=t+e,l=e<0?-1:r._tree.children.length;i!=l;i+=e){let f=r._tree.children[i];if(this.mode&S.IncludeAnonymous||f instanceof W||!f.type.isAnonymous||ce(f))return!1}return!0}move(e,t){if(t&&this.enterChild(e,0,4))return!0;for(;;){if(this.sibling(e))return!0;if(this.atLastNode(e)||!this.parent())return!1}}next(e=!0){return this.move(1,e)}prev(e=!0){return this.move(-1,e)}moveTo(e,t=0){for(;(this.from==this.to||(t<1?this.from>=e:this.from>e)||(t>-1?this.to<=e:this.to<e))&&this.parent(););for(;this.enterChild(1,e,t););return this}get node(){if(!this.buffer)return this._tree;let e=this.bufferNode,t=null,r=0;if(e&&e.context==this.buffer)e:for(let n=this.index,i=this.stack.length;i>=0;){for(let l=e;l;l=l._parent)if(l.index==n){if(n==this.index)return l;t=l,r=i+1;break e}n=this.stack[--i]}for(let n=r;n<this.stack.length;n++)t=new G(this.buffer,t,this.stack[n]);return this.bufferNode=new G(this.buffer,t,this.index)}get tree(){return this.buffer?null:this._tree._tree}iterate(e,t){for(let r=0;;){let n=!1;if(this.type.isAnonymous||e(this)!==!1){if(this.firstChild()){r++;continue}this.type.isAnonymous||(n=!0)}for(;;){if(n&&t&&t(this),n=this.type.isAnonymous,!r)return;if(this.nextSibling())break;this.parent(),r--,n=!0}}}matchContext(e){if(!this.buffer)return le(this.node.parent,e);let{buffer:t}=this.buffer,{types:r}=t.set;for(let n=e.length-1,i=this.stack.length-1;n>=0;i--){if(i<0)return le(this._tree,e,n);let l=r[t.buffer[this.stack[i]]];if(!l.isAnonymous){if(e[n]&&e[n]!=l.name)return!1;n--}}return!0}};function ce(s){return s.children.some(e=>e instanceof W||!e.type.isAnonymous||ce(e))}function Me(s){var e;let{buffer:t,nodeSet:r,maxBufferLength:n=1024,reused:i=[],minRepeatType:l=r.types.length}=s,f=Array.isArray(t)?new se(t,t.length):t,h=r.types,u=0,o=0;function c(m,v,a,A,x,C){let{id:g,start:p,end:w,size:k}=f,N=o,U=u;for(;k<0;)if(f.next(),k==-1){let L=i[g];a.push(L),A.push(p-m);return}else if(k==-3){u=g;return}else if(k==-4){o=g;return}else throw new RangeError(`Unrecognized record size: ${k}`);let K=h[g],X,H,me=p-m;if(w-p<=n&&(H=T(f.pos-v,x))){let L=new Uint16Array(H.size-H.skip),M=f.pos-H.size,D=L.length;for(;f.pos>M;)D=j(H.start,L,D);X=new W(L,w-H.start,r),me=H.start-m}else{let L=f.pos-k;f.next();let M=[],D=[],J=g>=l?g:-1,$=0,Y=w;for(;f.pos>L;)J>=0&&f.id==J&&f.size>=0?(f.end<=Y-n&&(_(M,D,p,$,f.end,Y,J,N,U),$=M.length,Y=f.end),f.next()):C>2500?d(p,L,M,D):c(p,L,M,D,J,C+1);if(J>=0&&$>0&&$<M.length&&_(M,D,p,$,p,Y,J,N,U),M.reverse(),D.reverse(),J>-1&&$>0){let ye=y(K,U);X=ge(K,M,D,0,M.length,0,w-p,ye,ye)}else X=B(K,M,D,w-p,N-w,U)}a.push(X),A.push(me)}function d(m,v,a,A){let x=[],C=0,g=-1;for(;f.pos>v;){let{id:p,start:w,end:k,size:N}=f;if(N>4)f.next();else{if(g>-1&&w<g)break;g<0&&(g=k-n),x.push(p,w,k),C++,f.next()}}if(C){let p=new Uint16Array(C*4),w=x[x.length-2];for(let k=x.length-3,N=0;k>=0;k-=3)p[N++]=x[k],p[N++]=x[k+1]-w,p[N++]=x[k+2]-w,p[N++]=N;a.push(new W(p,x[2]-w,r)),A.push(w-m)}}function y(m,v){return(a,A,x)=>{let C=0,g=a.length-1,p,w;if(g>=0&&(p=a[g])instanceof O){if(!g&&p.type==m&&p.length==x)return p;(w=p.prop(b.lookAhead))&&(C=A[g]+p.length+w)}return B(m,a,A,x,C,v)}}function _(m,v,a,A,x,C,g,p,w){let k=[],N=[];for(;m.length>A;)k.push(m.pop()),N.push(v.pop()+a-x);m.push(B(r.types[g],k,N,C-x,p-C,w)),v.push(x-a)}function B(m,v,a,A,x,C,g){if(C){let p=[b.contextHash,C];g=g?[p].concat(g):[p]}if(x>25){let p=[b.lookAhead,x];g=g?[p].concat(g):[p]}return new O(m,v,a,A,g)}function T(m,v){let a=f.fork(),A=0,x=0,C=0,g=a.end-n,p={size:0,start:0,skip:0};e:for(let w=a.pos-m;a.pos>w;){let k=a.size;if(a.id==v&&k>=0){p.size=A,p.start=x,p.skip=C,C+=4,A+=4,a.next();continue}let N=a.pos-k;if(k<0||N<w||a.start<g)break;let U=a.id>=l?4:0,K=a.start;for(a.next();a.pos>N;){if(a.size<0)if(a.size==-3)U+=4;else break e;else a.id>=l&&(U+=4);a.next()}x=K,A+=k,C+=U}return(v<0||A==m)&&(p.size=A,p.start=x,p.skip=C),p.size>4?p:void 0}function j(m,v,a){let{id:A,start:x,end:C,size:g}=f;if(f.next(),g>=0&&A<l){let p=a;if(g>4){let w=f.pos-(g-4);for(;f.pos>w;)a=j(m,v,a)}v[--a]=p,v[--a]=C-m,v[--a]=x-m,v[--a]=A}else g==-3?u=A:g==-4&&(o=A);return a}let E=[],I=[];for(;f.pos>0;)c(s.start||0,s.bufferStart||0,E,I,-1,0);let R=(e=s.length)!==null&&e!==void 0?e:E.length?I[0]+E[0].length:0;return new O(h[s.topID],E.reverse(),I.reverse(),R)}var ve=new WeakMap;function ee(s,e){if(!s.isAnonymous||e instanceof W||e.type!=s)return 1;let t=ve.get(e);if(t==null){t=1;for(let r of e.children){if(r.type!=s||!(r instanceof O)){t=1;break}t+=ee(s,r)}ve.set(e,t)}return t}function ge(s,e,t,r,n,i,l,f,h){let u=0;for(let _=r;_<n;_++)u+=ee(s,e[_]);let o=Math.ceil(u*1.5/8),c=[],d=[];function y(_,B,T,j,E){for(let I=T;I<j;){let R=I,m=B[I],v=ee(s,_[I]);for(I++;I<j;I++){let a=ee(s,_[I]);if(v+a>=o)break;v+=a}if(I==R+1){if(v>o){let a=_[R];y(a.children,a.positions,0,a.children.length,B[R]+E);continue}c.push(_[R])}else{let a=B[I-1]+_[I-1].length-m;c.push(ge(s,_,B,R,I,m,a,null,h))}d.push(m+E-i)}}return y(e,t,r,n,0),(f||h)(c,d,l)}var ke=class{constructor(){this.map=new WeakMap}setBuffer(e,t,r){let n=this.map.get(e);n||this.map.set(e,n=new Map),n.set(t,r)}getBuffer(e,t){let r=this.map.get(e);return r&&r.get(t)}set(e,t){e instanceof G?this.setBuffer(e.context.buffer,e.index,t):e instanceof P&&this.map.set(e.tree,t)}get(e){return e instanceof G?this.getBuffer(e.context.buffer,e.index):e instanceof P?this.map.get(e.tree):void 0}cursorSet(e,t){e.buffer?this.setBuffer(e.buffer.buffer,e.index,t):this.map.set(e.tree,t)}cursorGet(e){return e.buffer?this.getBuffer(e.buffer.buffer,e.index):this.map.get(e.tree)}},re=class s{constructor(e,t,r,n,i=!1,l=!1){this.from=e,this.to=t,this.tree=r,this.offset=n,this.open=(i?1:0)|(l?2:0)}get openStart(){return(this.open&1)>0}get openEnd(){return(this.open&2)>0}static addTree(e,t=[],r=!1){let n=[new s(0,e.length,e,0,!1,r)];for(let i of t)i.to>e.length&&n.push(i);return n}static applyChanges(e,t,r=128){if(!t.length)return e;let n=[],i=1,l=e.length?e[0]:null;for(let f=0,h=0,u=0;;f++){let o=f<t.length?t[f]:null,c=o?o.fromA:1e9;if(c-h>=r)for(;l&&l.from<c;){let d=l;if(h>=d.from||c<=d.to||u){let y=Math.max(d.from,h)-u,_=Math.min(d.to,c)-u;d=y>=_?null:new s(y,_,d.tree,d.offset+u,f>0,!!o)}if(d&&n.push(d),l.to>c)break;l=i<e.length?e[i++]:null}if(!o)break;h=o.toA,u=o.toA-o.toB}return n}},Ae=class{startParse(e,t,r){return typeof e=="string"&&(e=new oe(e)),r=r?r.length?r.map(n=>new z(n.from,n.to)):[new z(0,0)]:[new z(0,e.length)],this.createParse(e,t||[],r)}parse(e,t,r){let n=this.startParse(e,t,r);for(;;){let i=n.advance();if(i)return i}}},oe=class{constructor(e){this.string=e}get length(){return this.string.length}chunk(e){return this.string.slice(e)}get lineChunks(){return!1}read(e,t){return this.string.slice(e,t)}};function De(s){return(e,t,r,n)=>new pe(e,s,t,r,n)}var ne=class{constructor(e,t,r,n,i){this.parser=e,this.parse=t,this.overlay=r,this.target=n,this.from=i}};function Ce(s){if(!s.length||s.some(e=>e.from>=e.to))throw new RangeError("Invalid inner parse ranges given: "+JSON.stringify(s))}var ue=class{constructor(e,t,r,n,i,l,f){this.parser=e,this.predicate=t,this.mounts=r,this.index=n,this.start=i,this.target=l,this.prev=f,this.depth=0,this.ranges=[]}},ae=new b({perNode:!0}),pe=class{constructor(e,t,r,n,i){this.nest=t,this.input=r,this.fragments=n,this.ranges=i,this.inner=[],this.innerDone=0,this.baseTree=null,this.stoppedAt=null,this.baseParse=e}advance(){if(this.baseParse){let r=this.baseParse.advance();if(!r)return null;if(this.baseParse=null,this.baseTree=r,this.startInner(),this.stoppedAt!=null)for(let n of this.inner)n.parse.stopAt(this.stoppedAt)}if(this.innerDone==this.inner.length){let r=this.baseTree;return this.stoppedAt!=null&&(r=new O(r.type,r.children,r.positions,r.length,r.propValues.concat([[ae,this.stoppedAt]]))),r}let e=this.inner[this.innerDone],t=e.parse.advance();if(t){this.innerDone++;let r=Object.assign(Object.create(null),e.target.props);r[b.mounted.id]=new V(t,e.overlay,e.parser),e.target.props=r}return null}get parsedPos(){if(this.baseParse)return 0;let e=this.input.length;for(let t=this.innerDone;t<this.inner.length;t++)this.inner[t].from<e&&(e=Math.min(e,this.inner[t].parse.parsedPos));return e}stopAt(e){if(this.stoppedAt=e,this.baseParse)this.baseParse.stopAt(e);else for(let t=this.innerDone;t<this.inner.length;t++)this.inner[t].parse.stopAt(e)}startInner(){let e=new de(this.fragments),t=null,r=null,n=new q(new P(this.baseTree,this.ranges[0].from,0,null),S.IncludeAnonymous|S.IgnoreMounts);e:for(let i,l;;){let f=!0,h;if(this.stoppedAt!=null&&n.from>=this.stoppedAt)f=!1;else if(e.hasNode(n)){if(t){let u=t.mounts.find(o=>o.frag.from<=n.from&&o.frag.to>=n.to&&o.mount.overlay);if(u)for(let o of u.mount.overlay){let c=o.from+u.pos,d=o.to+u.pos;c>=n.from&&d<=n.to&&!t.ranges.some(y=>y.from<d&&y.to>c)&&t.ranges.push({from:c,to:d})}}f=!1}else if(r&&(l=Oe(r.ranges,n.from,n.to)))f=l!=2;else if(!n.type.isAnonymous&&(i=this.nest(n,this.input))&&(n.from<n.to||!i.overlay)){n.tree||Te(n);let u=e.findMounts(n.from,i.parser);if(typeof i.overlay=="function")t=new ue(i.parser,i.overlay,u,this.inner.length,n.from,n.tree,t);else{let o=_e(this.ranges,i.overlay||(n.from<n.to?[new z(n.from,n.to)]:[]));o.length&&Ce(o),(o.length||!i.overlay)&&this.inner.push(new ne(i.parser,o.length?i.parser.startParse(this.input,Ie(u,o),o):i.parser.startParse(""),i.overlay?i.overlay.map(c=>new z(c.from-n.from,c.to-n.from)):null,n.tree,o.length?o[0].from:n.from)),i.overlay?o.length&&(r={ranges:o,depth:0,prev:r}):f=!1}}else if(t&&(h=t.predicate(n))&&(h===!0&&(h=new z(n.from,n.to)),h.from<h.to)){let u=t.ranges.length-1;u>=0&&t.ranges[u].to==h.from?t.ranges[u]={from:t.ranges[u].from,to:h.to}:t.ranges.push(h)}if(f&&n.firstChild())t&&t.depth++,r&&r.depth++;else for(;!n.nextSibling();){if(!n.parent())break e;if(t&&!--t.depth){let u=_e(this.ranges,t.ranges);u.length&&(Ce(u),this.inner.splice(t.index,0,new ne(t.parser,t.parser.startParse(this.input,Ie(t.mounts,u),u),t.ranges.map(o=>new z(o.from-t.start,o.to-t.start)),t.target,u[0].from))),t=t.prev}r&&!--r.depth&&(r=r.prev)}}}};function Oe(s,e,t){for(let r of s){if(r.from>=t)break;if(r.to>e)return r.from<=e&&r.to>=t?2:1}return 0}function Se(s,e,t,r,n,i){if(e<t){let l=s.buffer[e+1];r.push(s.slice(e,t,l)),n.push(l-i)}}function Te(s){let{node:e}=s,t=[],r=e.context.buffer;do t.push(s.index),s.parent();while(!s.tree);let n=s.tree,i=n.children.indexOf(r),l=n.children[i],f=l.buffer,h=[i];function u(o,c,d,y,_,B){let T=t[B],j=[],E=[];Se(l,o,T,j,E,y);let I=f[T+1],R=f[T+2];h.push(j.length);let m=B?u(T+4,f[T+3],l.set.types[f[T]],I,R-I,B-1):e.toTree();return j.push(m),E.push(I-y),Se(l,f[T+3],c,j,E,y),new O(d,j,E,_)}n.children[i]=u(0,f.length,F.none,0,l.length,t.length-1);for(let o of h){let c=s.tree.children[o],d=s.tree.positions[o];s.yield(new P(c,d+s.from,o,s._tree))}}var ie=class{constructor(e,t){this.offset=t,this.done=!1,this.cursor=e.cursor(S.IncludeAnonymous|S.IgnoreMounts)}moveTo(e){let{cursor:t}=this,r=e-this.offset;for(;!this.done&&t.from<r;)t.to>=e&&t.enter(r,1,S.IgnoreOverlays|S.ExcludeBuffers)||t.next(!1)||(this.done=!0)}hasNode(e){if(this.moveTo(e.from),!this.done&&this.cursor.from+this.offset==e.from&&this.cursor.tree)for(let t=this.cursor.tree;;){if(t==e.tree)return!0;if(t.children.length&&t.positions[0]==0&&t.children[0]instanceof O)t=t.children[0];else break}return!1}},de=class{constructor(e){var t;if(this.fragments=e,this.curTo=0,this.fragI=0,e.length){let r=this.curFrag=e[0];this.curTo=(t=r.tree.prop(ae))!==null&&t!==void 0?t:r.to,this.inner=new ie(r.tree,-r.offset)}else this.curFrag=this.inner=null}hasNode(e){for(;this.curFrag&&e.from>=this.curTo;)this.nextFrag();return this.curFrag&&this.curFrag.from<=e.from&&this.curTo>=e.to&&this.inner.hasNode(e)}nextFrag(){var e;if(this.fragI++,this.fragI==this.fragments.length)this.curFrag=this.inner=null;else{let t=this.curFrag=this.fragments[this.fragI];this.curTo=(e=t.tree.prop(ae))!==null&&e!==void 0?e:t.to,this.inner=new ie(t.tree,-t.offset)}}findMounts(e,t){var r;let n=[];if(this.inner){this.inner.cursor.moveTo(e,1);for(let i=this.inner.cursor.node;i;i=i.parent){let l=(r=i.tree)===null||r===void 0?void 0:r.prop(b.mounted);if(l&&l.parser==t)for(let f=this.fragI;f<this.fragments.length;f++){let h=this.fragments[f];if(h.from>=i.to)break;h.tree==this.curFrag.tree&&n.push({frag:h,pos:i.from-h.offset,mount:l})}}}return n}};function _e(s,e){let t=null,r=e;for(let n=1,i=0;n<s.length;n++){let l=s[n-1].to,f=s[n].from;for(;i<r.length;i++){let h=r[i];if(h.from>=f)break;h.to<=l||(t||(r=t=e.slice()),h.from<l?(t[i]=new z(h.from,l),h.to>f&&t.splice(i+1,0,new z(f,h.to))):h.to>f?t[i--]=new z(f,h.to):t.splice(i--,1))}}return r}function je(s,e,t,r){let n=0,i=0,l=!1,f=!1,h=-1e9,u=[];for(;;){let o=n==s.length?1e9:l?s[n].to:s[n].from,c=i==e.length?1e9:f?e[i].to:e[i].from;if(l!=f){let d=Math.max(h,t),y=Math.min(o,c,r);d<y&&u.push(new z(d,y))}if(h=Math.min(o,c),h==1e9)break;o==h&&(l?(l=!1,n++):l=!0),c==h&&(f?(f=!1,i++):f=!0)}return u}function Ie(s,e){let t=[];for(let{pos:r,mount:n,frag:i}of s){let l=r+(n.overlay?n.overlay[0].from:0),f=l+n.tree.length,h=Math.max(i.from,l),u=Math.min(i.to,f);if(n.overlay){let o=n.overlay.map(d=>new z(d.from+r,d.to+r)),c=je(e,o,h,u);for(let d=0,y=h;;d++){let _=d==c.length,B=_?u:c[d].from;if(B>y&&t.push(new re(y,B,n.tree,-l,i.from>=y||i.openStart,i.to<=B||i.openEnd)),_)break;y=c[d].to}}else t.push(new re(h,u,n.tree,-l,i.from>=l||i.openStart,i.to<=f||i.openEnd))}return t}export{Fe as DefaultBufferLength,S as IterMode,V as MountedTree,b as NodeProp,xe as NodeSet,F as NodeType,ke as NodeWeakMap,Ae as Parser,O as Tree,W as TreeBuffer,q as TreeCursor,re as TreeFragment,De as parseMixed};
