import{EditorSelection as x,countColumn as b,Prec as V,EditorState as j}from"@codemirror/state";import{keymap as z}from"@codemirror/view";import{defineLanguageFacet as G,foldNodeProp as F,indentNodeProp as Q,languageDataProp as U,foldService as _,syntaxTree as B,Language as J,LanguageDescription as E,ParseContext as Y,indentUnit as Z,LanguageSupport as N}from"@codemirror/language";import{CompletionContext as W}from"@codemirror/autocomplete";import{parser as ee,GFM as te,Subscript as re,Superscript as ne,Emoji as oe,MarkdownParser as ie,parseCode as le}from"@lezer/markdown";import{html as se,htmlCompletionSource as fe}from"@codemirror/lang-html";import{NodeProp as me}from"@lezer/common";var q=G({commentTokens:{block:{open:"<!--",close:"-->"}}}),$=new me,H=ee.configure({props:[F.add(e=>!e.is("Block")||e.is("Document")||y(e)!=null||ae(e)?void 0:(i,n)=>({from:n.doc.lineAt(i.from).to,to:i.to})),$.add(y),Q.add({Document:()=>null}),U.add({Document:q})]});function y(e){let i=/^(?:ATX|Setext)Heading(\d)$/.exec(e.name);return i?+i[1]:void 0}function ae(e){return e.name=="OrderedList"||e.name=="BulletList"}function ue(e,i){let n=e;for(;;){let t=n.nextSibling,r;if(!t||(r=y(t.type))!=null&&r<=i)break;n=t}return n.to}var ce=_.of((e,i,n)=>{for(let t=B(e).resolveInner(n,-1);t&&!(t.from<i);t=t.parent){let r=t.type.prop($);if(r==null)continue;let l=ue(t,r);if(l>n)return{from:n,to:l}}return null});function T(e){return new J(q,e,[],"markdown")}var de=T(H),pe=H.configure([te,re,ne,oe,{props:[F.add({Table:(e,i)=>({from:i.doc.lineAt(e.from).to,to:e.to})})]}]),P=T(pe);function he(e,i){return n=>{if(n&&e){let t=null;if(n=/\S*/.exec(n)[0],typeof e=="function"?t=e(n):t=E.matchLanguageName(e,n,!0),t instanceof E)return t.support?t.support.language.parser:Y.getSkippingParser(t.load());if(t)return t.parser}return i?i.parser:null}}var w=class{constructor(i,n,t,r,l,f,a){this.node=i,this.from=n,this.to=t,this.spaceBefore=r,this.spaceAfter=l,this.type=f,this.item=a}blank(i,n=!0){let t=this.spaceBefore+(this.node.name=="Blockquote"?">":"");if(i!=null){for(;t.length<i;)t+=" ";return t}else{for(let r=this.to-this.from-t.length-this.spaceAfter.length;r>0;r--)t+=" ";return t+(n?this.spaceAfter:"")}}marker(i,n){let t=this.node.name=="OrderedList"?String(+X(this.item,i)[2]+n):"";return this.spaceBefore+t+this.type+this.spaceAfter}};function R(e,i){let n=[],t=[];for(let r=e;r;r=r.parent){if(r.name=="FencedCode")return t;(r.name=="ListItem"||r.name=="Blockquote")&&n.push(r)}for(let r=n.length-1;r>=0;r--){let l=n[r],f,a=i.lineAt(l.from),o=l.from-a.from;if(l.name=="Blockquote"&&(f=/^ *>( ?)/.exec(a.text.slice(o))))t.push(new w(l,o,o+f[0].length,"",f[1],">",null));else if(l.name=="ListItem"&&l.parent.name=="OrderedList"&&(f=/^( *)\d+([.)])( *)/.exec(a.text.slice(o)))){let m=f[3],s=f[0].length;m.length>=4&&(m=m.slice(0,m.length-4),s-=4),t.push(new w(l.parent,o,o+s,f[1],m,f[2],l))}else if(l.name=="ListItem"&&l.parent.name=="BulletList"&&(f=/^( *)([-+*])( {1,4}\[[ xX]\])?( +)/.exec(a.text.slice(o)))){let m=f[4],s=f[0].length;m.length>4&&(m=m.slice(0,m.length-4),s-=4);let c=f[2];f[3]&&(c+=f[3].replace(/[xX]/," ")),t.push(new w(l.parent,o,o+s,f[1],m,c,l))}}return t}function X(e,i){return/^(\s*)(\d+)(?=[.)])/.exec(i.sliceString(e.from,e.from+10))}function I(e,i,n,t=0){for(let r=-1,l=e;;){if(l.name=="ListItem"){let a=X(l,i),o=+a[2];if(r>=0){if(o!=r+1)return;n.push({from:l.from+a[1].length,to:l.from+a[0].length,insert:String(r+2+t)})}r=o}let f=l.nextSibling;if(!f)break;l=f}}function M(e,i){let n=/^[ \t]*/.exec(e)[0].length;if(!n||i.facet(Z)!="	")return e;let t=b(e,4,n),r="";for(let l=t;l>0;)l>=4?(r+="	",l-=4):(r+=" ",l--);return r+e.slice(n)}var ge=({state:e,dispatch:i})=>{let n=B(e),{doc:t}=e,r=null,l=e.changeByRange(f=>{if(!f.empty||!P.isActiveAt(e,f.from,-1)&&!P.isActiveAt(e,f.from,1))return r={range:f};let a=f.from,o=t.lineAt(a),m=R(n.resolveInner(a,-1),t);for(;m.length&&m[m.length-1].from>a-o.from;)m.pop();if(!m.length)return r={range:f};let s=m[m.length-1];if(s.to-s.spaceAfter.length>a-o.from)return r={range:f};let c=a>=s.to-s.spaceAfter.length&&!/\S/.test(o.text.slice(s.to));if(s.item&&c){let d=s.node.firstChild,h=s.node.getChild("ListItem","ListItem");if(d.to>=a||h&&h.to<a||o.from>0&&!/[^\s>]/.test(t.lineAt(o.from-1).text)){let u=m.length>1?m[m.length-2]:null,A,C="";u&&u.item?(A=o.from+u.from,C=u.marker(t,1)):A=o.from+(u?u.to:0);let S=[{from:A,to:a,insert:C}];return s.node.name=="OrderedList"&&I(s.item,t,S,-2),u&&u.node.name=="OrderedList"&&I(u.item,t,S),{range:x.cursor(A+C.length),changes:S}}else{let u=D(m,e,o);return{range:x.cursor(a+u.length+1),changes:{from:o.from,insert:u+e.lineBreak}}}}if(s.node.name=="Blockquote"&&c&&o.from){let d=t.lineAt(o.from-1),h=/>\s*$/.exec(d.text);if(h&&h.index==s.from){let u=e.changes([{from:d.from+h.index,to:d.to},{from:o.from+s.from,to:o.to}]);return{range:f.map(u),changes:u}}}let p=[];s.node.name=="OrderedList"&&I(s.item,t,p);let k=s.item&&s.item.from<o.from,g="";if(!k||/^[\s\d.)\-+*>]*/.exec(o.text)[0].length>=s.to)for(let d=0,h=m.length-1;d<=h;d++)g+=d==h&&!k?m[d].marker(t,1):m[d].blank(d<h?b(o.text,4,m[d+1].from)-g.length:null);let L=a;for(;L>o.from&&/\s/.test(o.text.charAt(L-o.from-1));)L--;return g=M(g,e),ke(s.node,e.doc)&&(g=D(m,e,o)+e.lineBreak+g),p.push({from:L,to:a,insert:e.lineBreak+g}),{range:x.cursor(L+g.length+1),changes:p}});return r?!1:(i(e.update(l,{scrollIntoView:!0,userEvent:"input"})),!0)};function O(e){return e.name=="QuoteMark"||e.name=="ListMark"}function ke(e,i){if(e.name!="OrderedList"&&e.name!="BulletList")return!1;let n=e.firstChild,t=e.getChild("ListItem","ListItem");if(!t)return!1;let r=i.lineAt(n.to),l=i.lineAt(t.from),f=/^[\s>]*$/.test(r.text);return r.number+(f?0:1)<l.number}function D(e,i,n){let t="";for(let r=0,l=e.length-2;r<=l;r++)t+=e[r].blank(r<l?b(n.text,4,e[r+1].from)-t.length:null,r<l);return M(t,i)}function xe(e,i){let n=e.resolveInner(i,-1),t=i;O(n)&&(t=n.from,n=n.parent);for(let r;r=n.childBefore(t);)if(O(r))t=r.from;else if(r.name=="OrderedList"||r.name=="BulletList")n=r.lastChild,t=n.to;else break;return n}var Le=({state:e,dispatch:i})=>{let n=B(e),t=null,r=e.changeByRange(l=>{let f=l.from,{doc:a}=e;if(l.empty&&P.isActiveAt(e,l.from)){let o=a.lineAt(f),m=R(xe(n,f),a);if(m.length){let s=m[m.length-1],c=s.to-s.spaceAfter.length+(s.spaceAfter?1:0);if(f-o.from>c&&!/\S/.test(o.text.slice(c,f-o.from)))return{range:x.cursor(o.from+c),changes:{from:o.from+c,to:f}};if(f-o.from==c&&(!s.item||o.from<=s.item.from||!/\S/.test(o.text.slice(0,s.to)))){let p=o.from+s.from;if(s.item&&s.node.from<s.item.from&&/\S/.test(o.text.slice(s.from,s.to))){let k=s.blank(b(o.text,4,s.to)-b(o.text,4,s.from));return p==o.from&&(k=M(k,e)),{range:x.cursor(p+k.length),changes:{from:p,to:o.from+s.to,insert:k}}}if(p<f)return{range:x.cursor(p),changes:{from:p,to:f}}}}}return t={range:l}});return t?!1:(i(e.update(r,{scrollIntoView:!0,userEvent:"delete"})),!0)},we=[{key:"Enter",run:ge},{key:"Backspace",run:Le}],K=se({matchClosingTags:!1});function Te(e={}){let{codeLanguages:i,defaultCodeLanguage:n,addKeymap:t=!0,base:{parser:r}=de,completeHTMLTags:l=!0,htmlTagLanguage:f=K}=e;if(!(r instanceof ie))throw new RangeError("Base parser provided to `markdown` should be a Markdown parser");let a=e.extensions?[e.extensions]:[],o=[f.support,ce],m;n instanceof N?(o.push(n.support),m=n.language):n&&(m=n);let s=i||m?he(i,m):void 0;a.push(le({codeParser:s,htmlParser:f.language.parser})),t&&o.push(V.high(z.of(we)));let c=T(r.configure(a));return l&&o.push(c.data.of({autocomplete:be})),new N(c,o)}function be(e){let{state:i,pos:n}=e,t=/<[:\-\.\w\u00b7-\uffff]*$/.exec(i.sliceDoc(n-25,n));if(!t)return null;let r=B(i).resolveInner(n,-1);for(;r&&!r.type.isTop;){if(r.name=="CodeBlock"||r.name=="FencedCode"||r.name=="ProcessingInstructionBlock"||r.name=="CommentBlock"||r.name=="Link"||r.name=="Image")return null;r=r.parent}return{from:n-t[0].length,to:n,options:Ae(),validFor:/^<[:\-\.\w\u00b7-\uffff]*$/}}var v=null;function Ae(){if(v)return v;let e=fe(new W(j.create({extensions:K}),0,!0));return v=e?e.options:[]}export{de as commonmarkLanguage,Le as deleteMarkupBackward,ge as insertNewlineContinueMarkup,Te as markdown,we as markdownKeymap,P as markdownLanguage};
