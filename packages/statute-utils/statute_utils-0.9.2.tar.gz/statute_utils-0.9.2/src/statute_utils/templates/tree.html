{# BRANCHING #}

{# The label class is added to style the heading consisting of an item and a caption #}
{%- macro create_branch_heading(unit) -%}
  {%- set clean_item = unit.item|default('Container')|string -%}
  {%- if clean_item|is_hidden -%}
    {% if unit.caption -%}
      <a class="label" data-slug="{{unit.id|set_mp_slug}}">
        <strong >{{unit.caption}}</strong>
      </a>
    {%- endif %}
  {%- else -%}
    <a class="label" data-slug="{{unit.id|set_mp_slug}}">
      <strong>{{clean_item}}</strong>
      {% if unit.caption -%}
        &nbsp;<em>{{unit.caption}}</em>
      {%- endif %}
    </a>{# Using literal &nbsp; (instead of adding a css style) makes converting from html to text easier. #}
  {%- endif -%}
{%- endmacro -%}

{%- macro create_branch(unit) -%}
  {{ create_branch_heading(unit)}}
  {% if unit.content -%}
    {{unit.content|trim|safe|md_to_html }} {# Needs to be safe since some unit content may have html #}
  {%- endif %}
  {% if unit|is_par -%}
    <a data-slug="{{unit.id|set_mp_slug}}" data-item="{{unit.item}}" class="par-branch"></a>
  {%- endif %}
{%- endmacro -%}

{%- macro create_branches(units) -%}
  {% if units -%}
    <ul>
      {%- for unit in units -%}
        <li data-slug="{{unit.id|set_mp_slug}}"
          {%- if unit|is_par %}data-par="true"{% endif -%}
          {%- if unit|has_history %}
            data-last-history-action="{{unit|get_last_action}}"
            data-last-history-category="{{unit|get_last_category}}"
            data-last-history-cause="{{unit|get_last_cause}}"
            {% if unit|get_last_action == "Originated" %}
              title="{{unit|get_last_cause}} originates from older statute."
            {% else %}
              title="{{unit|get_last_action|lower}} in {{unit|get_last_cause}}."
            {% endif %}
          {% endif -%}>
          {{ create_branch(unit) }}
          {%- set target_units = unit.units|from_json -%}
          {%- if target_units -%}
            {# determine whether par. 1 is in next ul tag or ul to start with par. 2.. #}
            {%- set child = target_units[0] -%}
            {%- if child|is_first_par -%}
              {{ create_branch(child) }}
              {{ create_branches(child.units) }}
              {% if target_units|length > 1 -%}
                {%- set target_units = target_units[1:] -%}
                {{ create_branches(target_units) }}
              {%- endif -%}
            {%- else -%}
              {{ create_branches(target_units) }}
            {%- endif -%}
          {%- endif -%}
        </li>
      {%- endfor -%}
    </ul>
  {%- endif %}
{%- endmacro -%}

{%- macro connect_breadcrumbs(units) -%}
  <span class="crumbs">
    {% for unit in units -%}
      <span class="crumb">
        {{ unit|crumb }}
      </span>
    {%- endfor %}
  </span>
{%- endmacro -%}

{%- macro create_paragraphs(units) -%}
  {% if units -%}
    {% for unit in units -%}
      {{ unit|paragrapher }}
      {{ create_paragraphs(unit.units|from_json) }}
    {%- endfor %}
  {%- endif %}
{%- endmacro -%}
