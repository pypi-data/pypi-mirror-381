import{as as ee,ar as se,a$ as te,S as R,aL as G,au as q,af as T,ae as le,i as A,y as oe,Y as L,m as D,D as ae,bi as x,aG as ne,ag as ie,W as J,f as W,c as y,o as c,a3 as F,n as M,a1 as n,ao as re,aF as de,l as ue,bj as ce,a as r,e as h,d as b,t as m,w as a,h as C,a4 as me,a2 as pe,I as he,aS as fe,z as Y,A as ge,bd as be,ax as Ce,a7 as ye,_ as ve,E as _e,J as De,ay as ke,F as P,x as B,v as _,K as we,aA as I,L as g,u as Ee}from"./index-dNNWAIVd.js";import{_ as Q}from"./VisibleEditor-Cu8Dn46x.js";import{E as Ve}from"./empty-DWHKFcu8.js";import{E as Me}from"./card-Djhj_n7s.js";import{E as Ie,a as Ne,b as ze}from"./table-column-DOb2WfUy.js";import{e as H,d as Ke}from"./select-CO8k9w1c.js";import{E as Se}from"./col-C5u5Vtxs.js";import{E as $e}from"./index-DZKm-OkM.js";import"./form-item-DpUxod6O.js";import"./_baseClone-BuDpXQJB.js";import"./index-bbWqbHVb.js";import"./index-yhbm8EWT.js";import"./validator-Dpb44VnO.js";import"./raf-LFZIwNI3.js";const U=e=>ee(e)||se(e)||te(e),Pe=R({accordion:Boolean,modelValue:{type:T([Array,String,Number]),default:()=>le([])},expandIconPosition:{type:T([String]),default:"right"},beforeCollapse:{type:T(Function)}}),Be={[q]:U,[G]:U},X=Symbol("collapseContextKey"),Te="ElCollapse",Fe=(e,s)=>{const o=A(H(e.modelValue)),u=i=>{o.value=i;const p=e.accordion?o.value[0]:o.value;s(q,p),s(G,p)},t=i=>{if(e.accordion)u([o.value[0]===i?"":i]);else{const p=[...o.value],f=p.indexOf(i);f>-1?p.splice(f,1):p.push(i),u(p)}},d=async i=>{const{beforeCollapse:p}=e;if(!p){t(i);return}const f=p(i);[x(f),ne(f)].includes(!0)||ie(Te,"beforeCollapse must return type `Promise<boolean>` or `boolean`"),x(f)?f.then(w=>{w!==!1&&t(i)}).catch(w=>{}):f&&t(i)};return oe(()=>e.modelValue,()=>o.value=H(e.modelValue),{deep:!0}),ae(X,{activeNames:o,handleItemClick:d}),{activeNames:o,setActiveNames:u}},We=e=>{const s=L("collapse");return{rootKls:D(()=>[s.b(),s.b(`icon-position-${e.expandIconPosition}`)])}},Ae=W({name:"ElCollapse"}),Le=W({...Ae,props:Pe,emits:Be,setup(e,{expose:s,emit:o}){const u=e,{activeNames:t,setActiveNames:d}=Fe(u,o),{rootKls:i}=We(u);return s({activeNames:t,setActiveNames:d}),(p,f)=>(c(),y("div",{class:M(n(i))},[F(p.$slots,"default")],2))}});var Oe=J(Le,[["__file","collapse.vue"]]);const je=R({title:{type:String,default:""},name:{type:T([String,Number]),default:void 0},icon:{type:de,default:re},disabled:Boolean}),xe=e=>{const s=ue(X),{namespace:o}=L("collapse"),u=A(!1),t=A(!1),d=ce(),i=D(()=>d.current++),p=D(()=>{var v;return(v=e.name)!=null?v:`${o.value}-id-${d.prefix}-${n(i)}`}),f=D(()=>s?.activeNames.value.includes(n(p)));return{focusing:u,id:i,isActive:f,handleFocus:()=>{setTimeout(()=>{t.value?t.value=!1:u.value=!0},50)},handleHeaderClick:v=>{if(e.disabled)return;const E=v.target;E?.closest("input, textarea, select")||(s?.handleItemClick(n(p)),u.value=!1,t.value=!0)},handleEnterClick:v=>{const E=v.target;E?.closest("input, textarea, select")||(v.preventDefault(),s?.handleItemClick(n(p)))}}},He=(e,{focusing:s,isActive:o,id:u})=>{const t=L("collapse"),d=D(()=>[t.b("item"),t.is("active",n(o)),t.is("disabled",e.disabled)]),i=D(()=>[t.be("item","header"),t.is("active",n(o)),{focusing:n(s)&&!e.disabled}]),p=D(()=>[t.be("item","arrow"),t.is("active",n(o))]),f=D(()=>[t.be("item","title")]),k=D(()=>t.be("item","wrap")),w=D(()=>t.be("item","content")),z=D(()=>t.b(`content-${n(u)}`)),v=D(()=>t.b(`head-${n(u)}`));return{itemTitleKls:f,arrowKls:p,headKls:i,rootKls:d,itemWrapperKls:k,itemContentKls:w,scopedContentId:z,scopedHeadId:v}},Ue=W({name:"ElCollapseItem"}),Re=W({...Ue,props:je,setup(e,{expose:s}){const o=e,{focusing:u,id:t,isActive:d,handleFocus:i,handleHeaderClick:p,handleEnterClick:f}=xe(o),{arrowKls:k,headKls:w,rootKls:z,itemTitleKls:v,itemWrapperKls:E,itemContentKls:K,scopedContentId:S,scopedHeadId:$}=He(o,{focusing:u,isActive:d,id:t});return s({isActive:d}),(V,O)=>(c(),y("div",{class:M(n(z))},[r("div",{id:n($),class:M(n(w)),"aria-expanded":n(d),"aria-controls":n(S),"aria-describedby":n(S),tabindex:V.disabled?-1:0,role:"button",onClick:n(p),onKeydown:he(fe(n(f),["stop"]),["space","enter"]),onFocus:n(i),onBlur:j=>u.value=!1},[r("span",{class:M(n(v))},[F(V.$slots,"title",{isActive:n(d)},()=>[b(m(V.title),1)])],2),F(V.$slots,"icon",{isActive:n(d)},()=>[h(n(pe),{class:M(n(k))},{default:a(()=>[(c(),C(me(V.icon)))]),_:1},8,["class"])])],42,["id","aria-expanded","aria-controls","aria-describedby","tabindex","onClick","onKeydown","onFocus","onBlur"]),h(n(be),null,{default:a(()=>[Y(r("div",{id:n(S),role:"region",class:M(n(E)),"aria-hidden":!n(d),"aria-labelledby":n($)},[r("div",{class:M(n(K))},[F(V.$slots,"default")],2)],10,["id","aria-hidden","aria-labelledby"]),[[ge,n(d)]])]),_:3})],2))}});var Z=J(Re,[["__file","collapse-item.vue"]]);const Ge=ye(Oe,{CollapseItem:Z}),qe=Ce(Z),Je={name:"ModulesManager",components:{VisibleEditor:Q},data(){const{t:e}=Ee();return{modules:[],searchKeyword:"",loading:!1,showBaseModules:!1,helpDialogVisible:!1,helpDoc:null,activeSections:["commands","options","regexp"],currentPage:1,pageSize:10,moduleConfigDialogWidth:"90%",debounceTimer:null,configDialogVisible:!1,configModuleName:"",configContent:"",initialConfigContent:"",unsavedConfigChanges:!1,configNotFound:!1,t:e}},computed:{filteredModules(){let e=this.modules;return this.searchKeyword&&(e=e.filter(s=>s.bind_prefix.toLowerCase().includes(this.searchKeyword.toLowerCase()))),this.showBaseModules||(e=e.filter(s=>!s.base)),e},pagedModules(){const e=(this.currentPage-1)*this.pageSize,s=e+this.pageSize;return this.filteredModules.slice(e,s)},totalModules(){return this.filteredModules.length},hasAnyHelp(){return this.helpDoc?.desc||this.helpDoc?.commands?.args?.length>0||this.helpDoc?.commands?.options?.length>0||this.helpDoc?.regexp?.length>0}},mounted(){this.refreshData(),window.addEventListener("resize",this.updateModuleConfigDialogWidth),this.updateModuleConfigDialogWidth()},beforeUnmount(){window.removeEventListener("resize",this.updateModuleConfigDialogWidth)},watch:{configContent(e){this.unsavedConfigChanges=e!==this.initialConfigContent}},methods:{debouncedRefresh(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>this.refreshData(),300)},handleSizeChange(e){this.pageSize=e,this.currentPage=1},handleCurrentChange(e){this.currentPage=e},async refreshData(){this.loading=!0;try{const e=localStorage.getItem("language")||"zh_cn",s=await I.get("/api/modules",{params:{locale:e}});s.status===200&&s.data.modules&&(this.modules=Object.entries(s.data.modules).map(([o,u])=>{const t=u?._db_load!==!1;return{name:o,bind_prefix:u?.bind_prefix||o,desc:u?.desc||"",developers:u?.developers||[],loaded:t,base:u?.base===!0,...u}}).sort((o,u)=>o.name.localeCompare(u.name)))}catch(e){g.error(this.$t("message.error.fetch")+e.message)}finally{this.loading=!1}},async getRelatedModules(e){try{return(await I.get(`/api/module/${e}/related`)).data.modules||[]}catch{return g.error(this.$t("message.error.fetch")+error.message),[]}},async handleHelp(e){try{const s=localStorage.getItem("language")||"zh_cn",o=await I.get(`/api/module/${e.name}/helpdoc`,{params:{locale:s}});o.status===200&&(this.helpDoc=o.data,this.helpDialogVisible=!0)}catch(s){g.error(this.$t("message.error.fetch")+s.message)}},async handleReload(e){let s="";if(e.base)s=this.t("modules.confirm.message.reload.base");else{const o=await this.getRelatedModules(e.name);o.length===0?s=this.t("modules.confirm.message.reload"):s=this.t("modules.confirm.message.reload.extra",{modules:o.map(u=>this.t("format.quote",{msg:u})).join(this.t("format.delimiter"))})}try{await $e.confirm(s,this.t("confirm.warning"),{confirmButtonText:this.t("button.confirm"),cancelButtonText:this.t("button.cancel"),type:"warning"}),(await I.post(`/api/module/${e.name}/reload`)).status===204&&(g.success(this.t("modules.message.reload.success")),this.refreshData())}catch(o){if(o==="cancel"||o?.message==="cancel")return;o.response?.status===422?(g.error(this.t("modules.message.reload.error.failed")),this.refreshData()):g.error(this.$t("message.error.fetch")+o.message)}},async handleUnload(e){try{(await I.post(`/api/module/${e.name}/unload`)).status===204&&(g.success(this.t("modules.message.unload.success")),this.refreshData())}catch(s){s.response?.status===422?(g.error(this.t("modules.message.unload.error.failed")),this.refreshData()):g.error(this.$t("message.error.fetch")+s.message)}},async handleLoad(e){try{(await I.post(`/api/module/${e.name}/load`)).status===204&&(g.success(this.t("modules.message.load.success")),this.refreshData())}catch(s){s.response?.status===422?(g.error(this.t("modules.message.load.error.failed")),this.refreshData()):g.error(this.$t("message.error.fetch")+s.message)}},updateModuleConfigDialogWidth(){const e=window.innerWidth;if(e<1024)this.moduleConfigDialogWidth="90%";else{const s=e*.9-400;this.moduleConfigDialogWidth=`${s}px`}},async openConfigEditor(e){this.configModuleName=e._py_module_name,this.configDialogVisible=!0,this.unsavedConfigChanges=!1,this.configNotFound=!1;try{const s=await I.get(`/api/config/module_${this.configModuleName}.toml`);this.configContent=s.data.content,this.initialConfigContent=s.data.content}catch(s){s.response?.status===404?this.configNotFound=!0:(g.error(this.t("message.error.fetch")+s.message),this.configDialogVisible=!1)}},async applyConfig(){try{await I.put(`/api/config/module_${this.configModuleName}.toml`,{content:this.configContent}),g.success(this.t("config.message.save.success")),this.initialConfigContent=this.configContent,this.unsavedConfigChanges=!1,this.configDialogVisible=!1}catch(e){g.error(this.t("message.error.fetch")+e.message)}},resetConfigDialog(){this.configDialogVisible=!1,this.configModuleName="",this.configContent="",this.initialConfigContent="",this.unsavedConfigChanges=!1,this.configNotFound=!1}}},Ye={class:"header-container"},Qe={class:"filter-container"},Xe={class:"filter-item"},Ze={style:{"margin-bottom":"15px"}},es={class:"pagination-wrapper"},ss={key:0},ts={class:"help-code"},ls={key:0},os={class:"help-code"},as={key:0},ns={class:"help-code"},is={key:0};function rs(e,s,o,u,t,d){const i=_e,p=De,f=Se,k=Ie,w=Ke,z=Ne,v=ze,E=Me,K=qe,S=Ge,$=Ve,V=we,O=Q,j=ke;return c(),y("div",null,[h(E,{class:"module-card",shadow:"never"},{default:a(()=>[r("div",Ye,[r("h3",null,[s[9]||(s[9]=r("i",{class:"mdi mdi-puzzle"},null,-1)),b(" "+m(e.$t("modules.title")),1)]),h(i,{onClick:d.refreshData,type:"primary",size:"small",disabled:t.loading,style:{float:"right","margin-left":"10px"}},{default:a(()=>[s[10]||(s[10]=r("i",{class:"mdi mdi-refresh"},null,-1)),b(" "+m(e.$t("button.refresh")),1)]),_:1},8,["onClick","disabled"])]),r("div",Qe,[h(f,{span:6},{default:a(()=>[r("div",Xe,[h(p,{modelValue:t.searchKeyword,"onUpdate:modelValue":s[0]||(s[0]=l=>t.searchKeyword=l),placeholder:e.$t("modules.input.module_name"),clearable:"",onInput:d.debouncedRefresh,"prefix-icon":e.Search},{prefix:a(()=>[...s[11]||(s[11]=[r("i",{class:"mdi mdi-magnify"},null,-1)])]),_:1},8,["modelValue","placeholder","onInput","prefix-icon"])])]),_:1})]),r("div",Ze,[h(i,{type:"info",size:"small",onClick:s[1]||(s[1]=l=>t.showBaseModules=!t.showBaseModules)},{default:a(()=>[r("i",{class:M(t.showBaseModules?"mdi mdi-eye-off-outline":"mdi mdi-eye-outline")},null,2),b(" "+m(t.showBaseModules?e.$t("modules.button.hide_base"):e.$t("modules.button.show_base")),1)]),_:1})]),Y((c(),C(z,{data:d.pagedModules,style:{width:"100%"},stripe:""},{default:a(()=>[h(k,{label:e.$t("modules.table.name"),"min-width":"140"},{default:a(({row:l})=>[r("span",{class:M({unloaded:!l.loaded})},m(l.bind_prefix),3)]),_:1},8,["label"]),h(k,{label:e.$t("modules.table.desc"),"min-width":"800"},{default:a(({row:l})=>[b(m(l.desc||"-"),1)]),_:1},8,["label"]),h(k,{label:e.$t("modules.table.developers"),"min-width":"400"},{default:a(({row:l})=>[(c(!0),y(P,null,B(l.developers,N=>(c(),C(w,{key:N,type:"info",style:{margin:"2px"}},{default:a(()=>[b(m(N),1)]),_:2},1024))),128))]),_:1},8,["label"]),h(k,{label:e.$t("data.table.status"),"min-width":"100"},{default:a(({row:l})=>[h(w,{type:l.base?"warning":l.loaded?"success":"danger"},{default:a(()=>[b(m(l.base?e.$t("modules.tag.base"):l.loaded?e.$t("modules.tag.loaded"):e.$t("modules.tag.unloaded")),1)]),_:2},1032,["type"])]),_:1},8,["label"]),h(k,{label:e.$t("table.operation"),"min-width":"420"},{default:a(({row:l})=>[h(i,{size:"small",type:"info",onClick:N=>d.handleHelp(l)},{default:a(()=>[s[12]||(s[12]=r("i",{class:"mdi mdi-help-circle-outline"},null,-1)),b(" "+m(e.$t("modules.button.helpdoc")),1)]),_:1},8,["onClick"]),l.base?_("",!0):(c(),C(i,{key:0,size:"small",type:"primary",onClick:N=>d.openConfigEditor(l)},{default:a(()=>[s[13]||(s[13]=r("i",{class:"mdi mdi-cog"},null,-1)),b(" "+m(e.$t("modules.button.config")),1)]),_:1},8,["onClick"])),!l.base&&l.loaded?(c(),C(i,{key:1,size:"small",type:"warning",onClick:N=>d.handleUnload(l)},{default:a(()=>[s[14]||(s[14]=r("i",{class:"mdi mdi-puzzle-remove"},null,-1)),b(" "+m(e.$t("modules.button.unload")),1)]),_:1},8,["onClick"])):_("",!0),!l.base&&!l.loaded?(c(),C(i,{key:2,size:"small",type:"success",onClick:N=>d.handleLoad(l)},{default:a(()=>[s[15]||(s[15]=r("i",{class:"mdi mdi-puzzle-plus"},null,-1)),b(" "+m(e.$t("modules.button.load")),1)]),_:1},8,["onClick"])):_("",!0),h(i,{size:"small",type:"danger",onClick:N=>d.handleReload(l)},{default:a(()=>[s[16]||(s[16]=r("i",{class:"mdi mdi-reload"},null,-1)),b(" "+m(e.$t("modules.button.reload")),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[j,t.loading]]),r("div",es,[d.totalModules>0?(c(),C(v,{key:0,background:"",layout:"prev, pager, next","current-page":t.currentPage,"onUpdate:currentPage":s[2]||(s[2]=l=>t.currentPage=l),"page-size":t.pageSize,total:d.totalModules,style:{"margin-top":"20px"},onCurrentChange:e.handlePageChange},null,8,["current-page","page-size","total","onCurrentChange"])):_("",!0)])]),_:1}),h(V,{modelValue:t.helpDialogVisible,"onUpdate:modelValue":s[5]||(s[5]=l=>t.helpDialogVisible=l),title:e.$t("modules.helpdoc.title",{module:t.helpDoc?.module_name}),width:"600px"},{footer:a(()=>[h(i,{onClick:s[4]||(s[4]=l=>t.helpDialogVisible=!1)},{default:a(()=>[b(m(e.$t("button.close")),1)]),_:1})]),default:a(()=>[t.helpDoc?(c(),y("div",ss,[d.hasAnyHelp?(c(),C(S,{key:0,modelValue:t.activeSections,"onUpdate:modelValue":s[3]||(s[3]=l=>t.activeSections=l)},{title:a(()=>[r("b",null,m(e.$t("modules.helpdoc.subtitle.desc")),1)]),default:a(()=>[r("p",null,m(t.helpDoc.desc),1),t.helpDoc.commands?.args?.length?(c(),C(K,{key:0,name:"commands"},{title:a(()=>[r("b",null,m(e.$t("modules.helpdoc.subtitle.command")),1)]),default:a(()=>[r("ul",null,[(c(!0),y(P,null,B(t.helpDoc.commands.args,l=>(c(),y("li",{key:l.args},[r("code",ts,m(l.args),1),l.desc?(c(),y("span",ls," - "+m(l.desc),1)):_("",!0)]))),128))])]),_:1})):_("",!0),t.helpDoc.commands?.options?.length?(c(),C(K,{key:1,name:"options"},{title:a(()=>[r("b",null,m(e.$t("modules.helpdoc.subtitle.option")),1)]),default:a(()=>[r("ul",null,[(c(!0),y(P,null,B(t.helpDoc.commands.options,l=>(c(),y("li",{key:Object.keys(l)[0]},[r("code",os,m(Object.keys(l)[0]),1),Object.values(l)[0]?(c(),y("span",as," - "+m(Object.values(l)[0]),1)):_("",!0)]))),128))])]),_:1})):_("",!0),t.helpDoc.regexp?.length?(c(),C(K,{key:2,name:"regexp"},{title:a(()=>[r("b",null,m(e.$t("modules.helpdoc.subtitle.regex")),1)]),default:a(()=>[r("ul",null,[(c(!0),y(P,null,B(t.helpDoc.regexp,l=>(c(),y("li",{key:l.pattern},[r("code",ns,m(l.pattern),1),l.desc?(c(),y("span",is," - "+m(l.desc),1)):_("",!0)]))),128))])]),_:1})):_("",!0)]),_:1},8,["modelValue"])):(c(),C($,{key:1,description:e.$t("modules.helpdoc.none")},null,8,["description"]))])):_("",!0)]),_:1},8,["modelValue","title"]),h(V,{modelValue:t.configDialogVisible,"onUpdate:modelValue":s[8]||(s[8]=l=>t.configDialogVisible=l),title:e.$t("modules.config.title",{module:t.configModuleName}),width:t.moduleConfigDialogWidth,"close-on-press-escape":!1,"close-on-click-modal":!1,onClose:d.resetConfigDialog},{footer:a(()=>[h(i,{onClick:s[7]||(s[7]=l=>t.configDialogVisible=!1)},{default:a(()=>[b(m(e.$t("button.cancel")),1)]),_:1}),h(i,{type:"primary",onClick:d.applyConfig,disabled:!t.unsavedConfigChanges},{default:a(()=>[b(m(e.$t("button.apply")),1)]),_:1},8,["onClick","disabled"])]),default:a(()=>[t.configNotFound?(c(),C(E,{key:0,shadow:"never"},{default:a(()=>[h($,{description:e.$t("modules.config.none")},null,8,["description"])]),_:1})):t.configDialogVisible?(c(),C(O,{key:1,modelValue:t.configContent,"onUpdate:modelValue":s[6]||(s[6]=l=>t.configContent=l),ref:"visibleEditor"},null,8,["modelValue"])):_("",!0)]),_:1},8,["modelValue","title","width","onClose"])])}const ks=ve(Je,[["render",rs],["__scopeId","data-v-9b4a64e2"]]);export{ks as default};
