name: Build and Publish

on: [push, pull_request]

env:
  PLUTOBOOK_VERSION: 0.10.0
jobs:
  build_sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Build sdist
        run: |
          python -m pip install -U pip build
          python -m build --sdist -Csetup-args=-Dsdist=true

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-sdist
          path: ./dist/*.tar.gz

  build_linux_wheels:
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag' || contains(github.event.head_commit.message, '[build:wheels]')
    steps:
      - uses: actions/checkout@v4
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.1.3
        env:
          CIBW_BUILD: |
            cp310-manylinux_x86_64
            cp311-manylinux_x86_64
            cp312-manylinux_x86_64
            cp313-manylinux_x86_64
            cp314-manylinux_x86_64
          CIBW_MANYLINUX_X86_64_IMAGE: ghcr.io/plutoprint/plutobook-manylinux_2_28_x86_64:v${{ env.PLUTOBOOK_VERSION }}
          CIBW_BEFORE_BUILD: >
            pip install auditwheel
          CIBW_REPAIR_WHEEL_COMMAND: >
            auditwheel repair -w {dest_dir} {wheel}
          CIBW_TEST_COMMAND: >
            python -c "import plutoprint; print(plutoprint.__build_info__)"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: cibw-linux-wheels
          path: ./wheelhouse/*.whl

  build_windows_wheels:
    runs-on: windows-latest
    if: github.ref_type == 'tag' || contains(github.event.head_commit.message, '[build:wheels]')
    steps:
      - uses: actions/checkout@v4
      - name: Install PlutoBook
        run: |
          curl -L https://github.com/plutoprint/plutobook/releases/download/v${{ env.PLUTOBOOK_VERSION }}/plutobook-win64-${{ env.PLUTOBOOK_VERSION }}.zip -o plutobook-win64.zip
          7z x plutobook-win64.zip
          sed -i "s|^prefix=.*|prefix=\${{ github.workspace }}/plutobook-win64|" plutobook-win64/lib/pkgconfig/plutobook.pc
          sed -i '/^Requires\.private/d' plutobook-win64/lib/pkgconfig/plutobook.pc

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.1.3
        env:
          CIBW_BUILD: cp310-win_amd64 cp311-win_amd64 cp312-win_amd64 cp313-win_amd64 cp314-win_amd64
          CIBW_BEFORE_BUILD: pip install delvewheel
          CIBW_ENVIRONMENT: |
            PKG_CONFIG='${{ github.workspace }}/plutobook-win64/bin/pkgconf.exe'
            PKG_CONFIG_PATH='${{ github.workspace }}/plutobook-win64/lib/pkgconfig'
          CIBW_REPAIR_WHEEL_COMMAND: >
            delvewheel repair -vv -w {dest_dir} {wheel} --add-path ${{ github.workspace }}/plutobook-win64/bin
          CIBW_TEST_COMMAND: >
            python -c "import plutoprint; print(plutoprint.__build_info__)"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: cibw-windows-wheels
          path: ./wheelhouse/*.whl

  build_macos_wheels:
    if: github.ref_type == 'tag' || contains(github.event.head_commit.message, '[build:wheels]')
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          brew install cairo expat icu4c freetype fontconfig harfbuzz curl jpeg-turbo webp ninja meson pkg-config

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.1.3
        env:
          MACOSX_DEPLOYMENT_TARGET: "14.0"
          CIBW_BUILD: |
            cp310-macosx_arm64
            cp311-macosx_arm64
            cp312-macosx_arm64
            cp313-macosx_arm64
            cp314-macosx_arm64
          CIBW_ENVIRONMENT_MACOS: >
            PKG_CONFIG_PATH='/opt/homebrew/opt/icu4c/lib/pkgconfig:$PKG_CONFIG_PATH'
          CIBW_BEFORE_BUILD_MACOS: >
            pip install delocate
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: >
            delocate-wheel -v -w {dest_dir} {wheel}
          CIBW_TEST_COMMAND: >
            python -c "import plutoprint; print(plutoprint.__build_info__)"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: cibw-macos-wheels
          path: ./wheelhouse/*.whl

  publish:
    needs: [build_sdist, build_linux_wheels, build_windows_wheels, build_macos_wheels]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.event.ref, 'refs/tags/v')
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: cibw-*
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true

      - name: Generate Release Note
        run: |
          echo "See changelog: https://plutoprint.readthedocs.io/en/latest/changelog.html#${GITHUB_REF_NAME//./-}" > RELEASENOTE.md
      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body_path: RELEASENOTE.md
          files: |
            dist/plutoprint-*.whl
            dist/plutoprint-*.tar.gz
