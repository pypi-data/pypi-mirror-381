import"../chunks/DsnmJJEf.js";import{o as De}from"../chunks/CfPWzxx9.js";import{p as Le,s as i,b as ae,u as I,g as e,d as t,e as B,t as _e,h as N,i as M,f as H,a as k,j as Oe,k as Re,l as _,n as V,m as Ie,r as Me,c as Ne}from"../chunks/XfyNEFST.js";import{i as Z,b as ge}from"../chunks/CyI3pj5p.js";import{F as Fe,g as We,a as Ee,r as Ae,b as me,S as Be,c as q,t as G,n as He}from"../chunks/C0T7Jkdw.js";import{D as J}from"../chunks/CZmx3lfa.js";import{B as pe}from"../chunks/xV1gGuCK.js";import{g as $}from"../chunks/CqS7hfz2.js";import{u as Te,g as Q}from"../chunks/BvtU7qVU.js";var Ue=N("<!> <!> <!> <!>",1),Ye=N("<!> <!>",1),Ke=N('<div class="text-center"><div class="spinner-border center" role="status"><span class="visually-hidden">Loading...</span></div></div>'),Ve=N('<div class="text-center">No data with this selection.</div>'),Ze=N('<div class="text-center text-muted mt-2">No dual data available.</div>'),qe=N("<!> <!>",1),Ge=N('<h1 class="mt-2 mb-4">The Energy Balance &ndash; Nodal</h1> <!> <div class="my-4"><!></div>',1);function ot(fe,ve){Le(ve,!0);let W=null,E=i(null),h=i(!1),y=i(!1),T=i(void 0),U=i(void 0),S=i(ae([])),z=i(ae([])),C=i(ae([]));const be=G(["Hourly","Daily","Weekly","Monthly"]);let o=i(null),g=i(null),m=i(null),p=i(null),x=i("Hourly"),ne=_(()=>{if(!e(o)||!e(o).solution_name)return"";let r=e(o).solution_name.split(".");return[r[r.length-1],e(o).scenario_name,"balance",e(m),e(g),e(p)].join("_")}),he=_(()=>e(ne)+"_duals"),le=_(()=>{if(e(E)===null)return"";let r=e(E).data.find(n=>n.carrier===e(m));return r?r[0]||r.units||"":e(E).data[0][0]||e(E).data[0].units||""}),A=i(null),X=i(0);I(()=>{e(o)?.detail?.system.unaggregated_time_steps_per_year!==void 0&&t(X,e(o).detail.system.unaggregated_time_steps_per_year,!0)}),I(()=>{e(X),B(()=>{t(A,null)})});let ye=_(()=>oe(`Energy [${e(le)}]`)),xe=_(()=>oe("Dual",!1,5));function oe(r,n=!0,u=2){return{animation:!1,normalized:!0,parsing:!1,responsive:!0,borderWidth:1,aspectRatio:u,elements:{point:{radius:0}},scales:{x:{type:"linear",stacked:!0,title:{display:!0,text:"Time"},ticks:{maxRotation:0,autoSkip:!0,callback:v=>Number(v).toFixed(0)},min:0,max:e(X)-1},y:{stacked:!0,beginAtZero:!0,title:{display:!0,text:r}}},interaction:{intersect:!1,mode:"nearest",axis:"x"},plugins:{legend:{display:n},zoom:{pan:{enabled:!0,modifierKey:"ctrl",mode:"x"},zoom:{drag:{enabled:!0},wheel:{enabled:!0},mode:"x"},limits:{x:{minRange:10,min:"original",max:"original"}}},tooltip:{callbacks:{label:v=>`${v.dataset.label}: ${v.formattedValue} ${e(le)}`}}}}}I(()=>{e(C),B(()=>{e(C).length>0&&(e(p)==null||!e(C).includes(Number(e(p))))&&t(p,e(C)[0].toString(),!0)})}),I(()=>{e(S),B(()=>{e(S).length>0&&(e(g)==null||!e(S).includes(e(g)))&&t(g,e(S)[0],!0)})}),I(()=>{e(z),B(()=>{e(z).length>0&&(e(m)==null||!e(z).includes(e(m)))&&t(m,e(z)[0],!0)})}),I(()=>{e(o),e(p),e(g),e(m),e(x),B(ke)}),De(()=>{t(p,Q("year")||e(p),!0),t(g,Q("node")||e(g),!0),t(m,Q("car")||e(m),!0),t(x,Q("window")||e(x),!0)}),I(()=>{e(p),e(g),e(m),e(x),_e().then(()=>{Te({year:e(p),node:e(g),car:e(m),window:e(x)})})});let we=_(()=>({Daily:24,Weekly:168,Monthly:720})[e(x)]||1);async function ke(){e(g)==null||e(m)==null||e(p)==null||e(o)==null||(t(y,!0),await(async r=>{var n=Re(r,2);W=n[0],t(E,n[1],!0)})(await Promise.all([We(e(o).solution_name,e(g),e(m),e(o).scenario_name,Number(e(p)),e(we)),Ee(e(o).solution_name,$("flow_export",e(o).version),e(o).scenario_name)])),t(y,!1),ze())}let se=_(()=>Array.from({length:e(K)},(r,n)=>n.toString())),Y=[],ee=[],te=i(0),ie=i(0),K=i(0);function $e(){return!e(o)||!e(g)||!e(m)||!e(p)||!W?[]:Object.entries(W).flatMap(([r,n])=>{if(!n||n.length===0||r==="constraint_nodal_energy_balance")return[];let u={node:[e(g)]};"technology"in n[0].index&&(u={technology:n.map(a=>a.index.technology)});const v=n.filter(a=>Object.entries(u).every(([l,d])=>d.includes(a.index[l]))),b={};return v.forEach(a=>{const l=a.index.technology||a.index.node||a.index.label||"";b[l]||(b[l]=new Array(a.data.length).fill(0)),a.data.forEach((d,w)=>{b[l][w]+=d})}),Object.entries(b).map(([a,l])=>{if(Object.keys(l).length==0)return null;const d=e(o).version,w={[$("flow_storage_discharge",d)]:s=>s+" (discharge)",[$("flow_transport_in",d)]:s=>s+" (transport in)",[$("flow_import",d)]:()=>"Import",[$("shed_demand",d)]:()=>"Shed Demand",[$("flow_storage_charge",d)]:s=>s+" (charge)",[$("flow_transport_out",d)]:s=>s+" (transport out)",[$("flow_export",d)]:()=>"Export"};let c=He(),F=c,f=Object.values(l).map((s,j)=>({x:j,y:s}));return r=="demand"?{data:f,label:"Demand",type:"line",stack:"ownCustomStack",fill:!1,borderColor:"black",backgroundColor:"white",borderWidth:2,stepped:!0,pointRadius:Object.keys(l).length==1?2:0}:{data:f,label:w[r]?.(a)||a,fill:"origin",borderColor:c,backgroundColor:F,stepped:!0,cubicInterpolationMode:"monotone",pointRadius:Object.keys(l).length==1?2:0}}).filter(a=>a!==null)})}function Se(){if(!e(o)||!e(g)||!e(m)||!e(p)||!W)return[];const n=W["constraint_nodal_energy_balance"];return!n||n.length===0?[]:n.map(u=>u.data.length==0?null:{data:u.data.map((b,a)=>({x:a,y:b})),label:`dual_${u.index.carrier}_${u.index.node}`,fill:!1,borderColor:"rgb(0, 0, 0)",backgroundColor:"rgb(0, 0, 0)",borderWidth:2,stepped:!0,cubicInterpolationMode:"monotone",pointRadius:u.data.length==1?2:0}).filter(u=>u!==null)}async function ze(){Ae(),Y=$e(),t(te,Y.length,!0),t(K,e(te)>0?Y[0].data.length:0,!0),ee=Se(),t(ie,ee.length,!0),await _e(),e(T)&&e(T).updateChart(Y),e(U)&&e(U).updateChart(ee)}var ue=Ge(),de=M(H(ue),2);Fe(de,{children:(r,n)=>{var u=Ye(),v=H(u);me(v,{title:"Solution Selection",children:(l,d)=>{{let w=_(()=>e(y)||e(h));Be(l,{get disabled(){return e(w)},get selected_solution(){return e(o)},set selected_solution(c){t(o,c,!0)},get carriers(){return e(z)},set carriers(c){t(z,c,!0)},get nodes(){return e(S)},set nodes(c){t(S,c,!0)},get years(){return e(C)},set years(c){t(C,c,!0)},get loading(){return e(h)},set loading(c){t(h,c,!0)}})}}});var b=M(v,2);{var a=l=>{me(l,{title:"Data Selection",children:(d,w)=>{var c=Ue(),F=H(c);q(F,{label:"Year",content:(P,D=V)=>{{let L=_(()=>G(e(C).map(R=>R.toString()))),O=_(()=>e(y)||e(h));J(P,{get formId(){return D()},get options(){return e(L)},get disabled(){return e(O)},get value(){return e(p)},set value(R){t(p,R,!0)}})}}});var f=M(F,2);q(f,{label:"Node",content:(P,D=V)=>{{let L=_(()=>G(e(S))),O=_(()=>e(y)||e(h));J(P,{get formId(){return D()},get options(){return e(L)},get disabled(){return e(O)},get value(){return e(g)},set value(R){t(g,R,!0)}})}}});var s=M(f,2);q(s,{label:"Carrier",content:(P,D=V)=>{{let L=_(()=>G(e(z))),O=_(()=>e(y)||e(h));J(P,{get formId(){return D()},get options(){return e(L)},get disabled(){return e(O)},get value(){return e(m)},set value(R){t(m,R,!0)}})}}});var j=M(s,2);q(j,{label:"Smoothing Window Size",content:(P,D=V)=>{{let L=_(()=>e(y)||e(h));J(P,{get formId(){return D()},get options(){return be},get disabled(){return e(L)},get value(){return e(x)},set value(O){t(x,O,!0)}})}}}),k(d,c)}})};Z(b,l=>{!e(h)&&e(o)&&l(a)})}k(r,u)}});var ce=M(de,2),Ce=Ie(ce);{var je=r=>{var n=Ke();k(r,n)},Pe=r=>{var n=Ne(),u=H(n);{var v=a=>{var l=Ve();k(a,l)},b=a=>{var l=qe(),d=H(l);{let f=_(()=>e(K)==1?"bar":"line");ge(pe(d,{get type(){return e(f)},get options(){return e(ye)},get labels(){return e(se)},datasets:[],get plot_name(){return e(ne)},zoom:!0,get zoomLevel(){return e(A)},set zoomLevel(s){t(A,s,!0)}}),s=>t(T,s,!0),()=>e(T))}var w=M(d,2);{var c=f=>{{let s=_(()=>e(K)==1?"bar":"line");ge(pe(f,{id:"chart-duals",get type(){return e(s)},get options(){return e(xe)},get labels(){return e(se)},datasets:[],get plot_name(){return e(he)},zoom:!0,narrow:!0,get zoomLevel(){return e(A)},set zoomLevel(j){t(A,j,!0)}}),j=>t(U,j,!0),()=>e(U))}},F=f=>{var s=Ze();k(f,s)};Z(w,f=>{e(ie)>0?f(c):f(F,!1)})}k(a,l)};Z(u,a=>{e(te)==0||e(o)==null?a(v):a(b,!1)},!0)}k(r,n)};Z(Ce,r=>{e(y)?r(je):r(Pe,!1)})}Me(ce),k(fe,ue),Oe()}export{ot as component};
