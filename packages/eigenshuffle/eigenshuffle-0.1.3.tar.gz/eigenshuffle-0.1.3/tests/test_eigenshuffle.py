import numpy as np
import numpy.typing as npt

from eigenshuffle import eigenshuffle_eig, eigenshuffle_eigh


def test_eigenshuffle_hermitian():
    def eigenvalue_function(
        t: float | npt.NDArray[np.floating],
    ) -> npt.NDArray[np.floating]:
        return np.array(
            [
                [1, 2 * t + 1, t**2, t**3],
                [2 * t + 1, 2 - t, t**2, 1 - t**3],
                [t**2, t**2, 3 - 2 * t, t**2],
                [t**3, 1 - t**3, t**2, 4 - 3 * t],
            ]
        )

    tseq = np.arange(-1, 1.1, 0.1, dtype=np.float64)
    Aseq = np.array([eigenvalue_function(ti) for ti in tseq])

    Dseq, Vseq = eigenshuffle_eigh(Aseq, use_eigenvalues=True)

    Dseq_result = np.array(
        [
            [2.01807787e-01, 2.34468977e00, 5.00000000e00, 8.45350244e00],
            [4.46444425e-01, 2.37278553e00, 4.76869965e00, 7.81207039e00],
            [6.50537693e-01, 2.34131394e00, 4.56000539e00, 7.24814297e00],
            [8.11802506e-01, 2.27094977e00, 4.36481455e00, 6.75243317e00],
            [9.23641655e-01, 2.18568005e00, 4.17511785e00, 6.31556045e00],
            [9.74449526e-01, 2.11183494e00, 3.98546098e00, 5.92825456e00],
            [9.52541286e-01, 2.07267152e00, 3.79314408e00, 5.58164312e00],
            [8.57997539e-01, 2.07681965e00, 3.59759344e00, 5.26758938e00],
            [7.05814192e-01, 2.11560230e00, 3.39948848e00, 4.97909503e00],
            [5.14941574e-01, 2.17419889e00, 3.19996664e00, 4.71089289e00],
            [3.00371852e-01, 2.23912328e00, 3.00000000e00, 4.46050487e00],
            [7.26886695e-02, 2.29713164e00, 2.79996981e00, 4.23020988e00],
            [-1.60340670e-01, 2.33034363e00, 2.59973107e00, 4.03026597e00],
            [-3.92718246e-01, 2.30635749e00, 2.40465559e00, 3.88170517e00],
            [-6.20014444e-01, 2.26280146e00, 2.14640989e00, 3.81080309e00],
            [-8.39923018e-01, 2.11113817e00, 1.89856712e00, 3.83021773e00],
            [-1.05365434e00, 1.92977085e00, 1.59374301e00, 3.93014048e00],
            [-1.26853285e00, 1.74502602e00, 1.23083725e00, 4.09266958e00],
            [-1.50228846e00, 1.57290562e00, 8.25152817e-01, 4.30423003e00],
            [-1.78830615e00, 1.42718321e00, 4.03893140e-01, 4.55722981e00],
            [-2.17554439e00, 1.32732731e00, 1.67320090e-15, 4.84821708e00],
        ]
    )

    Vseq_result = np.array(
        [
            [
                [8.85223372e-01, 3.32003327e-01, -3.01511345e-01, 1.23467738e-01],
                [3.70423332e-01, -8.41059546e-01, -1.11022302e-16, -3.94214910e-01],
                [-2.74534151e-01, 3.13073706e-02, -9.04534034e-01, -3.24759958e-01],
                [6.16209201e-02, 4.25925438e-01, 3.01511345e-01, -8.50812137e-01],
            ],
            [
                [9.06002863e-01, 3.23969224e-01, -2.53241587e-01, 1.00356627e-01],
                [3.45821240e-01, -8.60840934e-01, -1.19096729e-02, -3.73120243e-01],
                [-2.40566328e-01, 4.92393840e-02, -9.19412129e-01, -3.07220869e-01],
                [4.11621653e-02, 3.89322889e-01, 3.00679556e-01, -8.69669575e-01],
            ],
            [
                [9.30788746e-01, 2.92092758e-01, -2.05525786e-01, 7.79312690e-02],
                [3.02190487e-01, -8.85120820e-01, -2.32658883e-02, -3.53129923e-01],
                [-2.04035375e-01, 6.71636291e-02, -9.35260615e-01, -2.81329336e-01],
                [2.61301759e-02, 3.55994385e-01, 2.87237588e-01, -8.88864320e-01],
            ],
            [
                [9.58221328e-01, 2.29282635e-01, -1.61432953e-01, 5.63982476e-02],
                [2.32812614e-01, -9.12086824e-01, -3.09298668e-02, -3.36064363e-01],
                [-1.65149126e-01, 8.11851561e-02, -9.51331297e-01, -2.47191222e-01],
                [1.83286738e-02, 3.30054647e-01, 2.60675102e-01, -9.07070274e-01],
            ],
            [
                [9.83556722e-01, 1.27664305e-01, -1.22644621e-01, 3.57252813e-02],
                [1.29182021e-01, -9.36650280e-01, -3.33404520e-02, -3.23862120e-01],
                [-1.24523200e-01, 8.84742090e-02, -9.66546102e-01, -2.06045917e-01],
                [2.05463296e-02, 3.13943295e-01, 2.22789911e-01, -9.22703697e-01],
            ],
            [
                [9.95755431e-01, -1.50885811e-02, -8.94501872e-02, 1.55602148e-02],
                [-1.21422382e-02, -9.47427631e-01, -3.07161808e-02, -3.18260847e-01],
                [-8.41818454e-02, 8.67096806e-02, -9.79631232e-01, -1.60366761e-01],
                [3.51724965e-02, 3.07627454e-01, 1.77137884e-01, -9.34211119e-01],
            ],
            [
                [9.81575288e-01, -1.80885618e-01, -6.13764998e-02, -4.82413411e-03],
                [-1.74615415e-01, -9.30691804e-01, -2.44924809e-02, -3.20503263e-01],
                [-4.87355307e-02, 7.43285126e-02, -9.89535158e-01, -1.13667459e-01],
                [6.03676979e-02, 3.09141443e-01, 1.28270085e-01, -9.40390395e-01],
            ],
            [
                [9.41877115e-01, -3.32753957e-01, -3.78979926e-02, -2.65715393e-02],
                [-3.23144427e-01, -8.86341214e-01, -1.65692411e-02, -3.31213515e-01],
                [-2.32268931e-02, 5.32696553e-02, -9.95847719e-01, -7.00726505e-02],
                [8.89139559e-02, 3.17547478e-01, 8.10957674e-02, -9.40575029e-01],
            ],
            [
                [8.92750321e-01, -4.47217231e-01, -1.89785027e-02, -5.13169549e-02],
                [-4.35629059e-01, -8.29023644e-01, -8.76029552e-03, -3.50528712e-01],
                [-8.48945075e-03, 2.93302191e-02, -9.98960323e-01, -3.38517377e-02],
                [1.14682682e-01, 3.34449225e-01, 4.05135327e-02, -9.34532103e-01],
            ],
            [
                [8.47233652e-01, -5.24923576e-01, -5.51140628e-03, -8.13633952e-02],
                [-5.13505370e-01, -7.70116576e-01, -2.64283390e-03, -3.78451727e-01],
                [-1.74952930e-03, 9.09237032e-03, -9.99915309e-01, -9.14563757e-03],
                [1.36030557e-01, 3.62343797e-01, 1.14897592e-02, -9.21992758e-01],
            ],
            [
                [8.09712282e-01, -5.74426635e-01, 1.48029737e-16, -1.20000260e-01],
                [-5.66497504e-01, -7.11785415e-01, 2.96059473e-16, -4.15261485e-01],
                [-2.77555756e-17, -2.22044605e-16, -1.00000000e00, -2.22044605e-16],
                [1.53122822e-01, 4.04222173e-01, 1.11022302e-16, -9.01752647e-01],
            ],
            [
                [7.80247810e-01, -6.01357453e-01, -8.60424535e-03, -1.71780487e-01],
                [-6.03071614e-01, -6.50550104e-01, -4.58781830e-03, -4.61593049e-01],
                [-1.25785741e-03, 1.56765842e-02, -9.99821051e-01, -1.05132174e-02],
                [1.65880681e-01, 4.63581732e-01, 1.62106176e-02, -8.70237205e-01],
            ],
            [
                [7.57807308e-01, -6.03940882e-01, -5.07249047e-02, -2.41682599e-01],
                [-6.28948592e-01, -5.79703551e-01, -3.00492953e-02, -5.17169702e-01],
                [-4.38273435e-03, 9.56904461e-02, -9.94421822e-01, -4.41516619e-02],
                [1.73587280e-01, 5.38555978e-01, 8.74600650e-02, -8.19863191e-01],
            ],
            [
                [7.41390330e-01, -5.34644476e-01, -2.35506989e-01, -3.30200121e-01],
                [-6.47808018e-01, -4.70602515e-01, -1.62563731e-01, -5.76585707e-01],
                [-8.65415486e-03, 4.42364008e-01, -8.91193773e-01, -1.00064220e-01],
                [1.74957868e-01, 5.44979487e-01, 3.51970382e-01, -7.40610528e-01],
            ],
            [
                [7.30255685e-01, -4.97427423e-01, 1.97524445e-01, -4.24590021e-01],
                [-6.62022372e-01, -3.52970887e-01, 2.13728864e-01, -6.25665969e-01],
                [-1.34115347e-02, -2.55130838e-01, -9.52251713e-01, -1.67167767e-01],
                [1.68146197e-01, 7.50257134e-01, -9.23078651e-02, -6.32708738e-01],
            ],
            [
                [7.23841357e-01, -4.66585715e-01, 6.85131328e-02, -5.03644131e-01],
                [-6.73101985e-01, -3.20139849e-01, 1.40528580e-01, -6.51686975e-01],
                [-1.77219649e-02, 7.68985042e-02, -9.70292255e-01, -2.28703939e-01],
                [1.50576692e-01, 8.20910999e-01, 1.84636423e-01, -5.18980908e-01],
            ],
            [
                [7.21500791e-01, -4.08833374e-01, 2.45496071e-02, -5.58291320e-01],
                [-6.81885640e-01, -2.99698676e-01, 1.19139695e-01, -6.56519924e-01],
                [-1.99616882e-02, 2.88156234e-01, -9.16394178e-01, -2.77108690e-01],
                [1.18617511e-01, 8.12405047e-01, 3.81345985e-01, -4.24856641e-01],
            ],
            [
                [7.21924130e-01, -3.54723527e-01, 3.31594732e-02, -5.93209255e-01],
                [-6.88479916e-01, -3.05802892e-01, 1.05568266e-01, -6.49103487e-01],
                [-1.72035741e-02, 4.10956272e-01, -8.55516824e-01, -3.14499511e-01],
                [6.72680669e-02, 7.82157755e-01, 5.05812963e-01, -3.57571672e-01],
            ],
            [
                [7.21960063e-01, -3.05021092e-01, 8.23668508e-02, -6.15590370e-01],
                [-6.91856080e-01, -3.31694748e-01, 8.36593316e-02, -6.35857590e-01],
                [-4.57044311e-03, 4.64664210e-01, -8.15615314e-01, -3.44728796e-01],
                [-9.37781955e-03, 7.62251861e-01, 5.66558451e-01, -3.12882852e-01],
            ],
            [
                [7.15056089e-01, -2.53329047e-01, 1.64105252e-01, -6.30546311e-01],
                [-6.89186088e-01, -3.72454286e-01, 4.66440784e-02, -6.19777920e-01],
                [2.40572513e-02, 4.71635878e-01, -7.99875547e-01, -3.70378127e-01],
                [-1.14623620e-01, 7.58064507e-01, 5.75406731e-01, -2.84792420e-01],
            ],
            [
                [6.92537806e-01, -1.94546159e-01, 2.67261242e-01, -6.41182196e-01],
                [-6.76495638e-01, -4.24283525e-01, 2.22044605e-16, -6.01944467e-01],
                [7.06285104e-02, 4.44758891e-01, -8.01783726e-01, -3.92866389e-01],
                [-2.40326137e-01, 7.64411415e-01, 5.34522484e-01, -2.68708486e-01],
            ],
        ]
    )

    assert np.allclose(Dseq, Dseq_result)
    assert np.allclose(Vseq, Vseq_result)


def test_eigenshuffle():
    def eigenvalue_function(
        t: float,
    ) -> npt.NDArray[np.floating]:
        return np.array(
            [
                [1, 2 * t + 1, t**2, t**3],
                [2 * t + 1, 2 - t, t**2, 1 - t**3],
                [t**2, t**2, 3 - 2 * t, t**2],
                [t**3, 1 - t**3, t**2, 4 - 3 * t],
            ]
        )

    tseq = np.arange(-1, 1.1, 0.1, dtype=np.float64)
    Aseq = np.array([eigenvalue_function(ti) for ti in tseq])

    Dseq, Vseq = eigenshuffle_eig(Aseq, use_eigenvalues=True)

    Dseq_result = np.array(
        [
            [2.01807787e-01, 2.34468977e00, 5.00000000e00, 8.45350244e00],
            [4.46444425e-01, 2.37278553e00, 4.76869965e00, 7.81207039e00],
            [6.50537693e-01, 2.34131394e00, 4.56000539e00, 7.24814297e00],
            [8.11802506e-01, 2.27094977e00, 4.36481455e00, 6.75243317e00],
            [9.23641655e-01, 2.18568005e00, 4.17511785e00, 6.31556045e00],
            [9.74449526e-01, 2.11183494e00, 3.98546098e00, 5.92825456e00],
            [9.52541286e-01, 2.07267152e00, 3.79314408e00, 5.58164312e00],
            [8.57997539e-01, 2.07681965e00, 3.59759344e00, 5.26758938e00],
            [7.05814192e-01, 2.11560230e00, 3.39948848e00, 4.97909503e00],
            [5.14941574e-01, 2.17419889e00, 3.19996664e00, 4.71089289e00],
            [3.00371852e-01, 2.23912328e00, 3.00000000e00, 4.46050487e00],
            [7.26886695e-02, 2.29713164e00, 2.79996981e00, 4.23020988e00],
            [-1.60340670e-01, 2.33034363e00, 2.59973107e00, 4.03026597e00],
            [-3.92718246e-01, 2.30635749e00, 2.40465559e00, 3.88170517e00],
            [-6.20014444e-01, 2.26280146e00, 2.14640989e00, 3.81080309e00],
            [-8.39923018e-01, 2.11113817e00, 1.89856712e00, 3.83021773e00],
            [-1.05365434e00, 1.92977085e00, 1.59374301e00, 3.93014048e00],
            [-1.26853285e00, 1.74502602e00, 1.23083725e00, 4.09266958e00],
            [-1.50228846e00, 1.57290562e00, 8.25152817e-01, 4.30423003e00],
            [-1.78830615e00, 1.42718321e00, 4.03893140e-01, 4.55722981e00],
            [-2.17554439e00, 1.32732731e00, 1.58912173e-15, 4.84821708e00],
        ]
    )

    Vseq_result = np.array(
        [
            [
                [8.85223372e-01, 3.32003327e-01, 3.01511345e-01, -1.23467738e-01],
                [3.70423332e-01, -8.41059546e-01, 8.99952208e-17, 3.94214910e-01],
                [-2.74534151e-01, 3.13073706e-02, 9.04534034e-01, 3.24759958e-01],
                [6.16209201e-02, 4.25925438e-01, -3.01511345e-01, 8.50812137e-01],
            ],
            [
                [9.06002863e-01, 3.23969224e-01, 2.53241587e-01, -1.00356627e-01],
                [3.45821240e-01, -8.60840934e-01, 1.19096729e-02, 3.73120243e-01],
                [-2.40566328e-01, 4.92393840e-02, 9.19412129e-01, 3.07220869e-01],
                [4.11621653e-02, 3.89322889e-01, -3.00679556e-01, 8.69669575e-01],
            ],
            [
                [9.30788746e-01, 2.92092758e-01, 2.05525786e-01, -7.79312690e-02],
                [3.02190487e-01, -8.85120820e-01, 2.32658883e-02, 3.53129923e-01],
                [-2.04035375e-01, 6.71636291e-02, 9.35260615e-01, 2.81329336e-01],
                [2.61301759e-02, 3.55994385e-01, -2.87237588e-01, 8.88864320e-01],
            ],
            [
                [9.58221328e-01, 2.29282635e-01, 1.61432953e-01, -5.63982476e-02],
                [2.32812614e-01, -9.12086824e-01, 3.09298668e-02, 3.36064363e-01],
                [-1.65149126e-01, 8.11851561e-02, 9.51331297e-01, 2.47191222e-01],
                [1.83286738e-02, 3.30054647e-01, -2.60675102e-01, 9.07070274e-01],
            ],
            [
                [9.83556722e-01, 1.27664305e-01, 1.22644621e-01, -3.57252813e-02],
                [1.29182021e-01, -9.36650280e-01, 3.33404520e-02, 3.23862120e-01],
                [-1.24523200e-01, 8.84742090e-02, 9.66546102e-01, 2.06045917e-01],
                [2.05463296e-02, 3.13943295e-01, -2.22789911e-01, 9.22703697e-01],
            ],
            [
                [9.95755431e-01, -1.50885811e-02, 8.94501872e-02, -1.55602148e-02],
                [-1.21422382e-02, -9.47427631e-01, 3.07161808e-02, 3.18260847e-01],
                [-8.41818454e-02, 8.67096806e-02, 9.79631232e-01, 1.60366761e-01],
                [3.51724965e-02, 3.07627454e-01, -1.77137884e-01, 9.34211119e-01],
            ],
            [
                [9.81575288e-01, -1.80885618e-01, 6.13764998e-02, 4.82413411e-03],
                [-1.74615415e-01, -9.30691804e-01, 2.44924809e-02, 3.20503263e-01],
                [-4.87355307e-02, 7.43285126e-02, 9.89535158e-01, 1.13667459e-01],
                [6.03676979e-02, 3.09141443e-01, -1.28270085e-01, 9.40390395e-01],
            ],
            [
                [9.41877115e-01, -3.32753957e-01, 3.78979926e-02, 2.65715393e-02],
                [-3.23144427e-01, -8.86341214e-01, 1.65692411e-02, 3.31213515e-01],
                [-2.32268931e-02, 5.32696553e-02, 9.95847719e-01, 7.00726505e-02],
                [8.89139559e-02, 3.17547478e-01, -8.10957674e-02, 9.40575029e-01],
            ],
            [
                [8.92750321e-01, -4.47217231e-01, 1.89785027e-02, 5.13169549e-02],
                [-4.35629059e-01, -8.29023644e-01, 8.76029552e-03, 3.50528712e-01],
                [-8.48945075e-03, 2.93302191e-02, 9.98960323e-01, 3.38517377e-02],
                [1.14682682e-01, 3.34449225e-01, -4.05135327e-02, 9.34532103e-01],
            ],
            [
                [8.47233652e-01, -5.24923576e-01, 5.51140628e-03, 8.13633952e-02],
                [-5.13505370e-01, -7.70116576e-01, 2.64283390e-03, 3.78451727e-01],
                [-1.74952930e-03, 9.09237032e-03, 9.99915309e-01, 9.14563757e-03],
                [1.36030557e-01, 3.62343797e-01, -1.14897592e-02, 9.21992758e-01],
            ],
            [
                [8.09712282e-01, -5.74426635e-01, 6.48230758e-63, 1.20000260e-01],
                [-5.66497504e-01, -7.11785415e-01, -4.93038066e-32, 4.15261485e-01],
                [-2.79304834e-32, -3.50937304e-32, 1.00000000e00, 2.04739720e-32],
                [1.53122822e-01, 4.04222173e-01, -3.24115379e-63, 9.01752647e-01],
            ],
            [
                [7.80247810e-01, -6.01357453e-01, 8.60424535e-03, 1.71780487e-01],
                [-6.03071614e-01, -6.50550104e-01, 4.58781830e-03, 4.61593049e-01],
                [-1.25785741e-03, 1.56765842e-02, 9.99821051e-01, 1.05132174e-02],
                [1.65880681e-01, 4.63581732e-01, -1.62106176e-02, 8.70237205e-01],
            ],
            [
                [7.57807308e-01, -6.03940882e-01, 5.07249047e-02, 2.41682599e-01],
                [-6.28948592e-01, -5.79703551e-01, 3.00492953e-02, 5.17169702e-01],
                [-4.38273435e-03, 9.56904461e-02, 9.94421822e-01, 4.41516619e-02],
                [1.73587280e-01, 5.38555978e-01, -8.74600650e-02, 8.19863191e-01],
            ],
            [
                [7.41390330e-01, -5.34644476e-01, 2.35506989e-01, 3.30200121e-01],
                [-6.47808018e-01, -4.70602515e-01, 1.62563731e-01, 5.76585707e-01],
                [-8.65415486e-03, 4.42364008e-01, 8.91193773e-01, 1.00064220e-01],
                [1.74957868e-01, 5.44979487e-01, -3.51970382e-01, 7.40610528e-01],
            ],
            [
                [7.30255685e-01, -4.97427423e-01, -1.97524445e-01, 4.24590021e-01],
                [-6.62022372e-01, -3.52970887e-01, -2.13728864e-01, 6.25665969e-01],
                [-1.34115347e-02, -2.55130838e-01, 9.52251713e-01, 1.67167767e-01],
                [1.68146197e-01, 7.50257134e-01, 9.23078651e-02, 6.32708738e-01],
            ],
            [
                [7.23841357e-01, -4.66585715e-01, -6.85131328e-02, 5.03644131e-01],
                [-6.73101985e-01, -3.20139849e-01, -1.40528580e-01, 6.51686975e-01],
                [-1.77219649e-02, 7.68985042e-02, 9.70292255e-01, 2.28703939e-01],
                [1.50576692e-01, 8.20910999e-01, -1.84636423e-01, 5.18980908e-01],
            ],
            [
                [7.21500791e-01, -4.08833374e-01, -2.45496071e-02, 5.58291320e-01],
                [-6.81885640e-01, -2.99698676e-01, -1.19139695e-01, 6.56519924e-01],
                [-1.99616882e-02, 2.88156234e-01, 9.16394178e-01, 2.77108690e-01],
                [1.18617511e-01, 8.12405047e-01, -3.81345985e-01, 4.24856641e-01],
            ],
            [
                [7.21924130e-01, -3.54723527e-01, -3.31594732e-02, 5.93209255e-01],
                [-6.88479916e-01, -3.05802892e-01, -1.05568266e-01, 6.49103487e-01],
                [-1.72035741e-02, 4.10956272e-01, 8.55516824e-01, 3.14499511e-01],
                [6.72680669e-02, 7.82157755e-01, -5.05812963e-01, 3.57571672e-01],
            ],
            [
                [7.21960063e-01, -3.05021092e-01, -8.23668508e-02, 6.15590370e-01],
                [-6.91856080e-01, -3.31694748e-01, -8.36593316e-02, 6.35857590e-01],
                [-4.57044311e-03, 4.64664210e-01, 8.15615314e-01, 3.44728796e-01],
                [-9.37781955e-03, 7.62251861e-01, -5.66558451e-01, 3.12882852e-01],
            ],
            [
                [7.15056089e-01, -2.53329047e-01, -1.64105252e-01, 6.30546311e-01],
                [-6.89186088e-01, -3.72454286e-01, -4.66440784e-02, 6.19777920e-01],
                [2.40572513e-02, 4.71635878e-01, 7.99875547e-01, 3.70378127e-01],
                [-1.14623620e-01, 7.58064507e-01, -5.75406731e-01, 2.84792420e-01],
            ],
            [
                [6.92537806e-01, -1.94546159e-01, -2.67261242e-01, 6.41182196e-01],
                [-6.76495638e-01, -4.24283525e-01, -2.84066092e-16, 6.01944467e-01],
                [7.06285104e-02, 4.44758891e-01, 8.01783726e-01, 3.92866389e-01],
                [-2.40326137e-01, 7.64411415e-01, -5.34522484e-01, 2.68708486e-01],
            ],
        ]
    )

    assert np.allclose(Dseq, Dseq_result)
    assert np.allclose(Vseq, Vseq_result)
