{% extends "base.j2" -%}

{%- block append_to_head_tag_section %}
  <link rel="canonical" href="{{ product.absolute_url(request) }}" />
  <title>{{ product.title }}</title>
  <meta property="og:title" content="{{ product.title }}" />
  <meta name="description" content="{{ product.description }}">
  <meta property="og:description" content="{{ product.description }}" />
  <meta property="og:type" content="article" />
  {%- set og_thumbnail = none %}
  {%- for thumbnail_key in ["thumbnail1", "thumbnail2", "thumbnail3", "thumbnail4"] %}
    {%- if og_thumbnail is none and thumbnail_key in product.extensions %}
      {%- set og_thumbnail = thumbnail_key %}
    {%- endif %}
  {%- endfor %}
  {%- if og_thumbnail %}
  <meta property="og:image" content="{{ request.app["bucket.secure_uploads.get_endpoint"] }}/{{ product.s3_path }}/{{ og_thumbnail }}?ts={{ product.updated_timestamp }}" />
  {%- endif %}

  {% if product.has_product_file and signed_get_object_url is not none %}
  <script>
    // Simple web 1.5 refresh mechanism:
    // redirects to self every 9 minutes to get fresh signed & secure download URIs.
    // 540000 is 9 minutes in milliseconds.
    setTimeout(function() {
      window.location.href = window.location.href;
    }, 540000);
  </script>
  {% endif %}
{%- endblock append_to_head_tag_section -%}

{%- block call_to_action -%}
{% if request.user.can_edit_shop(request.shop) %}
<a href="/p/{{ product.id }}/edit" class="product-edit-button mps-button mps-button-small">&#9998; Edit</a>
{% endif %}
{%- endblock call_to_action -%}

{% block content -%}

<section class="two-column">

  <section class="product-left">

    <h1>{{ product.title }}</h1>
    <h3>
    sold by
    <a href="{{ product.shop.absolute_about_url(request) }}" rel="nofollow">{{ product.shop.name }}</a>
    </h3>

    {% if "thumbnail1" in product.extensions %}
    <img src="{{ request.app["bucket.secure_uploads.get_endpoint"] }}/{{ product.s3_path }}/thumbnail1?ts={{ product.updated_timestamp }}" class="product-main" />
    <br/>
    {% endif %}
    
    {% for file_key in product.file_thumbnail_keys %}
    {% if file_key in product.s3_key_thumbnails %}
    {% set get_endpoint = request.app["bucket.secure_uploads.get_endpoint"] + "/" + product.s3_key_thumbnails[file_key] %}
    <a href="{{ get_endpoint }}" target="_blank"><img src="{{ get_endpoint }}?ts={{ product.updated_timestamp }}" class="product-thumbnail" /></a>
    {% endif %}
    {% endfor %}

  </section>
  
  <section class="product-right">

  <br>
  <br>
  <br>

  <div class="well">
  <h1>${{ '{:,.2f}'.format(product.price) }}</h1>

  {% if product.is_ready %}
 
    {% if not product.is_physical %}
 
      {% if signed_get_object_url is not none %}
        <a href="{{ signed_get_object_url }}" class="product-download-button mps-button" download>&#11123 Download</a>
        <br/>
        <br/>
        <hr/>
        <br/>
      {% endif %}
    {% endif %}

    {% if product.is_physical %}
      {% set inventory = product.inventories | selectattr('shop_location_id', 'equalto', request.shop_location.id) | first %}
      {% if inventory and inventory.quantity > 0 %}
<form method="POST" action="{{ request.route_url('cart_add_product') }}">
  {% include "snippets/csrf.j2" %}
  <input type="hidden" name="product_id" value="{{ product.id }}">
  <button type="submit" class="product-download-button mps-button">Add To Cart</button>
</form>
      {% else %}
        <button class="product-download-button mps-button" style="background-color: red; cursor: not-allowed;" disabled>Sold Out</button>
        {% if request.shop.shop_locations.all()|length > 1 %}
          <p>This item is sold out at this location.
          <br> You can <a href="{{ request.route_url('shop_locations', shop_id=request.shop.id, _query={'next': request.url}) }}">switch shop locations</a> to check availability.</p>
        {% endif %}
      {% endif %}
    {% else %}
<form method="POST" action="{{ request.route_url('cart_add_product') }}">
  {% include "snippets/csrf.j2" %}
  <input type="hidden" name="product_id" value="{{ product.id }}">
  <button type="submit" class="product-download-button mps-button">Add To Cart</button>
</form>
    {% endif %}
    
    <br/>
    {% if (not request.user or not request.user.authenticated) and signed_get_object_url is none %}
    <br/>
    Already purchased? <a href="/join-or-log-in">log in</a>
    <br/>
    <br/>
    <br/>
    {% endif %}

    {% if "preview" in product.extensions %}
      <a href="{{ request.app["bucket.secure_uploads.get_endpoint"] }}/{{ product.s3_path }}/preview?ts={{ product.updated_timestamp }}" class="product-preview-button mps-button" download>View Preview</a>
      <br/>
    {% endif %}
  
  {% else %}
  
  <br>
  This product is not ready for sale yet.
  
  {% endif %}
  <div>

  </section>

</section>

<section class="one-column" style="max-width: 960px;">

  <br/>

  <b>Description</b>
  <section>{{ product.description_html | safe }}</section>

  <br/>
  <br/>
  
  {% if product.is_bundle %}

    {% if product.products_in_this_bundle %}
    <ul>
    {% for p in product.products_in_this_bundle %}
    <li>
      {{p.title}}
    </li>
    {% endfor %}
    </ul>
    {% endif %}

  {% elif product.has_product_file %}
    <b>File Type</b>
    <br/>
    {{ product.get_content_type("product") }} {{ product_size }}
    <br/>
    Please make sure you have an application to open this file type.

  {% endif %}

  <br/>
  <br/>
  
  <!-- Comments Section -->
  {% include 'snippets/comments.j2' %}

  <br/>
  <a href="/" class="product-edit-button mps-button">Back to shop</a>

</section>

{%- endblock -%}
