# Add this build step to your compose file:
# build:
#   context: .
#   dockerfile: Dockerfile.eigenpuls
#   env:
#     EIGENPULS_VERSION: X.Y.Z
#     EIGENPULS_INTERNAL_PORT: 4242
#

# Build stage
FROM python:3.12-slim AS build
WORKDIR /app
COPY eigenpuls.yaml /app/eigenpuls.yaml
ARG EIGENPULS_VERSION
RUN pip install --upgrade pip && pip install eigenpuls==${EIGENPULS_VERSION}
RUN EIGENPULS_CONFIG=/app/eigenpuls.yaml python -m eigenpuls packages --type apt > /app/.apt.txt

# Final stage
FROM python:3.12-slim
ENV DEBIAN_FRONTEND=noninteractive
COPY --from=build /app/.apt.txt /app/.apt.txt
RUN apt-get update \
 && apt-get install -y --no-install-recommends curl \
 && xargs -r apt-get install -y --no-install-recommends < /app/.apt.txt \
 && rm -rf /var/lib/apt/lists/*
ARG EIGENPULS_VERSION
RUN pip install --no-cache-dir eigenpuls==${EIGENPULS_VERSION}
WORKDIR /app
COPY eigenpuls.yaml /app/eigenpuls.yaml
ENV EIGENPULS_CONFIG=/app/eigenpuls.yaml
EXPOSE ${EIGENPULS_INTERNAL_PORT:-4242}
CMD ["python", "-m", "eigenpuls", "serve", "-c", "/app/eigenpuls.yaml"]
