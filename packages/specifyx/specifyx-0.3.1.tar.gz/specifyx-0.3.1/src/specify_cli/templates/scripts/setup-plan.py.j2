#!/usr/bin/env python3
"""
Setup implementation plan structure for current branch.

Automates creation of plan directories and files for feature branches.
Supports multiple branch patterns and provides JSON output for scripting.

Generated by SpecifyX init command for {{ ai_assistant }}.
"""

from pathlib import Path
from typing import Dict, Optional, Tuple

import typer
from rich.console import Console

from specify_cli.utils.script_helpers import (
    ScriptHelpers,
    echo_debug,
    echo_error,
    echo_info,
    echo_success,
)

app = typer.Typer(add_completion=False)
console = Console()


def get_feature_paths(
    helpers: ScriptHelpers, spec_id: Optional[str] = None
) -> Tuple[bool, Dict[str, str]]:
    """Get all feature-related paths using ScriptHelpers."""
    try:
        current_branch = helpers.get_current_branch()

    except Exception as e:
        return False, {"error": f"Git error: {str(e)}"}

    if not current_branch:
        return False, {"error": "No current branch detected"}

    # If spec_id is provided, use it directly
    if spec_id:
        feature_dir = helpers.find_spec_by_id(spec_id)
        if not feature_dir:
            available_specs = helpers.list_available_specs()
            if available_specs:
                spec_list = "\n".join(
                    [f"  {spec['id']} - {spec['name']}" for spec in available_specs]
                )
                return False, {
                    "error": f"Spec ID '{spec_id}' not found.\n\nAvailable specs:\n{spec_list}"
                }
            else:
                return False, {
                    "error": f"Spec ID '{spec_id}' not found. No specs available. Create one with: specifyx run create-feature 'feature name'"
                }
    else:
        # Traditional workflow: try to detect from branch
        if helpers.is_feature_branch(current_branch):
            feature_dir = helpers.find_feature_directory(current_branch)
            if not feature_dir:
                return False, {
                    "error": f"Cannot find feature directory for branch: {current_branch}"
                }
        else:
            # On main/non-feature branch without spec_id - show available specs
            available_specs = helpers.list_available_specs()
            if available_specs:
                spec_list = "\n".join(
                    [
                        f"  specifyx run setup-plan --spec-id {spec['id']}"
                        for spec in available_specs
                    ]
                )
                spec_names = "\n".join(
                    [f"  {spec['id']} - {spec['name']}" for spec in available_specs]
                )
                return False, {
                    "error": f"Multiple specs available on {current_branch} branch. Specify which one to use:\n{spec_list}\n\nAvailable specs:\n{spec_names}"
                }
            else:
                return False, {
                    "error": "No specs found. Create one with: specifyx run create-feature 'feature name'"
                }

    feature_spec = feature_dir / "spec.md"
    impl_plan = feature_dir / "plan.md"

    return True, {
        "FEATURE_SPEC": str(feature_spec.absolute()),
        "IMPL_PLAN": str(impl_plan.absolute()),
        "SPECS_DIR": str(feature_dir.absolute()),
        "BRANCH": current_branch,
    }


def setup_plan_structure(
    helpers: ScriptHelpers,
    spec_id: Optional[str] = None,
    force: bool = False,
    quiet: bool = False,
    json_mode: bool = False,
    debug: bool = False,
) -> Tuple[bool, Dict[str, str]]:
    """Setup implementation plan structure."""
    success, result = get_feature_paths(helpers, spec_id)
    if not success:
        return False, result

    repo_root = helpers.get_repo_root()
    feature_dir = Path(result["SPECS_DIR"])
    impl_plan = Path(result["IMPL_PLAN"])
    feature_spec = Path(result["FEATURE_SPEC"])

    echo_debug(f"Setting up structure in: {feature_dir}", debug)

    try:
        # Create feature directory
        if not feature_dir.exists():
            echo_info(
                f"Creating feature directory: {feature_dir.relative_to(Path.cwd())}",
                quiet,
            )
            feature_dir.mkdir(parents=True, exist_ok=True)

        # Handle implementation plan
        if not impl_plan.exists() or force:
            template_path = repo_root / ".specify" / "templates" / "plan-template.md.j2"
            if template_path.exists():
                echo_info("Creating plan from template", quiet)
                success, error = helpers.render_template_standalone(
                    template_path=template_path,
                    context_dict={
                        "feature_name": result["BRANCH"],
                        "branch_name": result["BRANCH"],
                        "author_name": "{{ author_name }}",
                        "creation_date": "{{ creation_date }}",
                        "project_name": "{{ project_name }}",
                    },
                    output_path=impl_plan,
                )
                if not success:
                    echo_error(
                        f"Failed to render plan template: {error}",
                        json_mode=json_mode,
                        quiet=quiet,
                    )
                    return False, {"error": f"Template rendering failed: {error}"}
            else:
                echo_error(
                    f"Plan template not found at {template_path}",
                    json_mode=json_mode,
                    quiet=quiet,
                )
                return False, {"error": f"Plan template not found: {template_path}"}

        # Ensure spec.md exists
        if not feature_spec.exists():
            template_path = repo_root / ".specify" / "templates" / "spec-template.md.j2"
            if template_path.exists():
                echo_info("Creating spec from template", quiet)
                success, error = helpers.render_template_standalone(
                    template_path=template_path,
                    context_dict={
                        "feature_name": result["BRANCH"],
                        "branch_name": result["BRANCH"],
                        "author_name": "{{ author_name }}",
                        "creation_date": "{{ creation_date }}",
                        "project_name": "{{ project_name }}",
                    },
                    output_path=feature_spec,
                )
                if not success:
                    echo_error(
                        f"Failed to render spec template: {error}",
                        json_mode=json_mode,
                        quiet=quiet,
                    )
                    return False, {"error": f"Template rendering failed: {error}"}
            else:
                echo_error(
                    f"Spec template not found at {template_path}",
                    json_mode=json_mode,
                    quiet=quiet,
                )
                return False, {"error": f"Spec template not found: {template_path}"}

        return True, result

    except Exception as e:
        echo_debug(f"Exception: {type(e).__name__}: {e}", debug)
        return False, {"error": f"Failed to setup plan structure: {str(e)}"}


@app.command()
def check(
    spec_id: Optional[str] = typer.Option(
        None,
        "--spec-id",
        help="Spec ID to work with (e.g., '001', '004') - required when multiple specs exist",
    ),
    json_mode: bool = typer.Option(
        False, "--json", help="Output results in JSON format"
    ),
    quiet: bool = typer.Option(
        False, "--quiet", "-q", help="Suppress informational messages"
    ),
    debug: bool = typer.Option(False, "--debug", help="Enable debug output"),
):
    """Check current status without creating files."""
    helpers = ScriptHelpers()
    echo_debug("Running in check-only mode", debug)

    success, result = get_feature_paths(helpers, spec_id)

    if not success:
        helpers.output_result(result, success=False, json_mode=json_mode)
        if not json_mode and "Not on a feature branch" in result.get("error", ""):
            echo_info("\nSuggested actions:", quiet)
            echo_info(
                "1. Switch to feature branch: git checkout 001-your-feature", quiet
            )
            echo_info("2. Create new branch: git checkout -b 002-new-feature", quiet)
        raise typer.Exit(1)

    # Check file status
    feature_spec = Path(result["FEATURE_SPEC"])
    impl_plan = Path(result["IMPL_PLAN"])
    specs_dir = Path(result["SPECS_DIR"])

    if json_mode:
        status = {
            **result,
            "status": "READY"
            if all(p.exists() for p in [specs_dir, feature_spec, impl_plan])
            else "NEEDS_SETUP",
        }
        helpers.output_result(status, json_mode=True)
    else:
        echo_info(f"Feature branch detected: {result['BRANCH']}", quiet)
        echo_info(
            f"Status: {'READY' if all(p.exists() for p in [specs_dir, feature_spec, impl_plan]) else 'NEEDS_SETUP'}",
            quiet,
        )


@app.command()
def setup(
    spec_id: Optional[str] = typer.Option(
        None,
        "--spec-id",
        help="Spec ID to work with (e.g., '001', '004') - required when multiple specs exist",
    ),
    json_mode: bool = typer.Option(
        False, "--json", help="Output results in JSON format"
    ),
    quiet: bool = typer.Option(
        False, "--quiet", "-q", help="Suppress informational messages"
    ),
    debug: bool = typer.Option(False, "--debug", help="Enable debug output"),
    force: bool = typer.Option(
        False, "--force", help="Force creation even if files exist"
    ),
):
    """Setup implementation plan structure for current branch or specific spec.

    Detects current feature branch and creates necessary directory structure,
    spec files, and plan templates. For no-branch workflow, use --spec-id.

    Examples:
        # Traditional workflow (on feature branch)
        specifyx run setup-plan setup

        # No-branch workflow (specify spec ID)
        specifyx run setup-plan setup --spec-id 004
        specifyx run setup-plan setup --json
        specifyx run setup-plan setup --force

    Note: If 'specifyx' is not found, try: uvx specifyx run setup-plan setup
    """
    helpers = ScriptHelpers()

    # Main operation
    success, result = setup_plan_structure(
        helpers, spec_id, force, quiet, json_mode, debug
    )

    if success:
        echo_success(
            "Successfully setup implementation plan structure", quiet, json_mode
        )
        helpers.output_result(result, success=True, json_mode=json_mode)
        echo_debug("Setup completed successfully", debug)
    else:
        helpers.output_result(result, success=False, json_mode=json_mode)
        if not json_mode and "Not on a feature branch" in result.get("error", ""):
            echo_info("\nTo fix this issue:", quiet)
            echo_info(
                "1. Switch to feature branch: git checkout 001-your-feature", quiet
            )
            echo_info("2. Create new branch: git checkout -b 002-new-feature", quiet)
        raise typer.Exit(1)


if __name__ == "__main__":
    app()
